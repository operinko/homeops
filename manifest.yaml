apiVersion: v1
kind: Service
metadata:
  annotations:
    io.cilium/lb-ipam-ips: 192.168.7.8
  labels:
    app.kubernetes.io/instance: technitium
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: technitium
    app.kubernetes.io/service: technitium-ns1
    helm.sh/chart: app-template-4.6.2
    helm.toolkit.fluxcd.io/name: technitium
    helm.toolkit.fluxcd.io/namespace: network
  name: technitium-ns1
  namespace: network
spec:
  ports:
  - name: dns-doh
    port: 443
    protocol: TCP
    targetPort: 443
  - name: dns-doh-http
    port: 80
    protocol: TCP
    targetPort: 80
  - name: dns-dot
    port: 853
    protocol: TCP
    targetPort: 853
  - name: dns-tcp
    port: 53
    protocol: TCP
    targetPort: 53
  - name: dns-udp
    port: 53
    protocol: UDP
    targetPort: 53
  selector:
    app.kubernetes.io/controller: technitium
    app.kubernetes.io/instance: technitium
    app.kubernetes.io/name: technitium
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/instance: technitium
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: technitium
    app.kubernetes.io/service: technitium
    helm.sh/chart: app-template-4.6.2
    helm.toolkit.fluxcd.io/name: technitium
    helm.toolkit.fluxcd.io/namespace: network
  name: technitium
  namespace: network
spec:
  ports:
  - name: http
    port: 5380
    protocol: TCP
    targetPort: 5380
  selector:
    app.kubernetes.io/controller: technitium
    app.kubernetes.io/instance: technitium
    app.kubernetes.io/name: technitium
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/controller: technitium
    app.kubernetes.io/instance: technitium
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: technitium
    helm.sh/chart: app-template-4.6.2
    helm.toolkit.fluxcd.io/name: technitium
    helm.toolkit.fluxcd.io/namespace: network
  name: technitium
  namespace: network
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/controller: technitium
      app.kubernetes.io/instance: technitium
      app.kubernetes.io/name: technitium
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/controller: technitium
        app.kubernetes.io/instance: technitium
        app.kubernetes.io/name: technitium
    spec:
      automountServiceAccountToken: false
      containers:
      - envFrom:
        - secretRef:
            name: technitium-secret
        image: technitium/dns-server:14.3.0
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              # Check if DNS server responds to queries
              # Using dig to query localhost for a test record
              timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
          failureThreshold: 3
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
        name: app
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - |
              # Check if DNS server responds to queries
              timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
          failureThreshold: 3
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        resources:
          limits:
            memory: 1246Mi
          requests:
            cpu: 127m
            memory: 1246Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: false
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - |
              # Check if DNS server responds to queries
              timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
          failureThreshold: 30
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 5
        volumeMounts:
        - mountPath: /etc/dns
          name: config
        - mountPath: /certs
          name: tls-secret
          readOnly: true
      dnsPolicy: ClusterFirst
      enableServiceLinks: false
      hostIPC: false
      hostNetwork: false
      hostPID: false
      hostname: ns1
      initContainers:
      - command:
        - sh
        - -c
        - 'openssl pkcs12 -export -legacy -keypbe PBE-SHA1-3DES -certpbe PBE-SHA1-3DES
          -macalg sha1 -out /etc/dns/ssl.pfx -inkey /certs/tls.key -in /certs/tls.crt
          -passout pass:'
        image: alpine/openssl:3.5.4
        imagePullPolicy: IfNotPresent
        name: mk-pfx
        volumeMounts:
        - mountPath: /etc/dns
          name: config
        - mountPath: /certs
          name: tls-secret
          readOnly: true
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: default
      volumes:
      - name: config
        persistentVolumeClaim:
          claimName: technitium
      - name: tls-secret
        secret:
          secretName: vaderrp-com-production-tls

