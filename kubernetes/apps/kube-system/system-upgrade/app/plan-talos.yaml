---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: talos-v1-10-7-control-plane
  namespace: system-upgrade
  labels:
    k8s-upgrade: talos
spec:
  serviceAccountName: system-upgrade
  # One control-plane at a time
  concurrency: 1
  cordon: true
  drain:
    force: true
    skipWaitForDeleteTimeout: 60
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
  upgrade:
    # talosctl client image matching Talos v1.10.x
    image: ghcr.io/siderolabs/talosctl:v1.10.7
    command:
      - sh
      - -c
      - |
        set -euo pipefail
        TALOS_IMAGE="factory.talos.dev/nocloud-installer/d0375ab0c19b88aaf2e41c17f25d395970111cd43dbbf197a56096809d810aa3:v1.10.7"
        echo "Upgrading ${SYSTEM_UPGRADE_NODE_NAME} to ${TALOS_IMAGE}"
        talosctl upgrade --nodes "${SYSTEM_UPGRADE_NODE_NAME}" --image="${TALOS_IMAGE}" --timeout=10m --wait

