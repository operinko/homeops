---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: descheduler
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: kube-system
  sources:
    - repoURL: https://kubernetes-sigs.github.io/descheduler/
      targetRevision: 0.34.0
      chart: descheduler
      helm:
        valuesObject:
          kind: Deployment
          deschedulerPolicyAPIVersion: descheduler/v1alpha2
          resources:
            requests:
              cpu: 23m
              memory: 100Mi
          deschedulerPolicy:
            profiles:
              - name: Default
                pluginConfig:
                  - name: DefaultEvictor
                    args:
                      evictFailedBarePods: true
                      evictLocalStoragePods: true
                      evictSystemCriticalPods: true
                  - name: PodLifeTime
                    args:
                      # Clean up completed VolSync destination pods to prevent PVC deletion deadlocks
                      # These pods block kubernetes.io/pvc-protection finalizer removal
                      states:
                        - Succeeded
                      namespaces:
                        exclude:
                          - kube-system
                      maxPodLifeTimeSeconds: 300 # 5 minutes
                  - name: RemoveFailedPods
                    args:
                      reasons:
                        - ContainerStatusUnknown
                        - NodeAffinity
                        - NodeShutdown
                        - Terminated
                        - UnexpectedAdmissionError
                      includingInitContainers: true
                      excludeOwnerKinds:
                        - Job
                      minPodLifetimeSeconds: 1800
                  - name: RemovePodsViolatingInterPodAntiAffinity
                  - name: RemovePodsViolatingNodeAffinity
                    args:
                      nodeAffinityType:
                        - requiredDuringSchedulingIgnoredDuringExecution
                  - name: RemovePodsViolatingNodeTaints
                  - name: RemovePodsViolatingTopologySpreadConstraint
                  - name: RemovePodsHavingTooManyRestarts
                    args:
                      podRestartThreshold: 100
                      includingInitContainers: true
                  - name: RemoveDuplicates
                  - name: LowNodeUtilization
                    args:
                      useDeviationThresholds: true
                      thresholds:
                        cpu: 20
                        memory: 20
                        pods: 20
                      targetThresholds:
                        cpu: 20
                        memory: 20
                        pods: 20
                plugins:
                  balance:
                    enabled:
                      - RemovePodsViolatingTopologySpreadConstraint
                      - RemoveDuplicates
                      - LowNodeUtilization
                  deschedule:
                    enabled:
                      - PodLifeTime
                      - RemoveFailedPods
                      - RemovePodsViolatingInterPodAntiAffinity
                      - RemovePodsViolatingNodeAffinity
                      - RemovePodsViolatingNodeTaints
                      - RemovePodsHavingTooManyRestarts
          service:
            enabled: true
          serviceMonitor:
            enabled: true
          leaderElection:
            enabled: true
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  syncPolicy:
    automated:
      prune: false
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - RespectIgnoreDifferences=true
  ignoreDifferences:
    # Ignore Flux HelmRelease status and labels
    - group: helm.toolkit.fluxcd.io
      kind: HelmRelease
      jsonPointers:
        - /status
        - /metadata/labels
