---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: technitium
  namespace: network
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: technitium
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    controllers:
      technitium:
        strategy: Recreate
        pod:
          hostname: ns1
        initContainers:
          mk-pfx:
            image:
              repository: alpine/openssl
              tag: "3.5.5"
              pullPolicy: IfNotPresent
            command:
              - sh
              - -c
              - >-
                openssl pkcs12 -export -legacy -keypbe PBE-SHA1-3DES -certpbe PBE-SHA1-3DES -macalg sha1
                -out /etc/dns/ssl.pfx -inkey /certs/tls.key -in /certs/tls.crt -passout pass:
        containers:
          app:
            image:
              repository: technitium/dns-server
              tag: 14.3.0
            envFrom:
              - secretRef:
                  name: technitium-secret
            ports:
              - name: clustering
                containerPort: 53443
                protocol: TCP
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: false
              capabilities: { drop: ["ALL"] }
            resources:
              requests:
                cpu: 127m
                memory: 1246Mi
              limits:
                memory: 1246Mi
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - |
                        # Check if DNS server responds to queries
                        # Using dig to query localhost for a test record
                        timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - |
                        # Check if DNS server responds to queries
                        timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              startup:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - sh
                      - -c
                      - |
                        # Check if DNS server responds to queries
                        timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  timeoutSeconds: 5
                  failureThreshold: 30
    defaultPodOptions:
      automountServiceAccountToken: false
      enableServiceLinks: false
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
    service:
      technitium:
        controller: technitium
        ports:
          http:
            port: 5380
      # Individual node LoadBalancer IP for all DNS protocols
      ns1:
        controller: technitium
        type: LoadBalancer
        clusterIP: 10.42.1.179
        externalTrafficPolicy: Local
        labels:
          io.cilium/ipam: static
        annotations:
          io.cilium/lb-ipam-ips: "192.168.7.8"
        ports:
          dns-tcp:
            enabled: true
            port: 53
            protocol: TCP
          dns-udp:
            enabled: true
            port: 53
            protocol: UDP
          dns-dot:
            enabled: true
            port: 853
            protocol: TCP
          dns-doh-http:
            enabled: true
            port: 80
            protocol: TCP
          dns-doh:
            enabled: true
            port: 443
            protocol: TCP
          clustering:
            enabled: true
            port: 53443
            protocol: TCP
    persistence:
      config:
        existingClaim: technitium
        globalMounts:
          - path: /etc/dns
      tls-secret:
        type: secret
        name: technitium-ns1-production-tls
        globalMounts:
          - path: /certs
            readOnly: true
