---
# Pre-sync hook to create a backup before CNPG cluster updates
apiVersion: batch/v1
kind: Job
metadata:
  name: cnpg-pre-sync-backup
  namespace: database
  annotations:
    #argocd.argoproj.io/hook: PreSync
    #argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      name: cnpg-backup
    spec:
      restartPolicy: Never
      serviceAccountName: postgres17
      containers:
        - name: backup
          image: alpine/k8s:1.35.1
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "=== CloudNative-PG Pre-Sync Backup ==="
              echo "Timestamp: $(date -Iseconds)"

              # Check if cluster exists
              if ! kubectl get cluster postgres17 -n database &>/dev/null; then
                echo "Cluster postgres17 does not exist yet, skipping backup"
                exit 0
              fi

              # Get cluster status
              CLUSTER_STATUS=$(kubectl get cluster postgres17 -n database -o jsonpath='{.status.phase}')
              echo "Cluster status: $CLUSTER_STATUS"

              if [ "$CLUSTER_STATUS" != "Cluster in healthy state" ]; then
                echo "⚠ Cluster is not healthy, skipping backup to avoid issues"
                exit 0
              fi

              # Trigger on-demand backup
              BACKUP_NAME="pre-sync-backup-$(date +%Y%m%d-%H%M%S)"
              echo "Creating backup: $BACKUP_NAME"

              cat <<EOF | kubectl apply -f -
              apiVersion: postgresql.cnpg.io/v1
              kind: Backup
              metadata:
                name: $BACKUP_NAME
                namespace: database
              spec:
                method: plugin
                pluginConfiguration:
                  name: barman-cloud.cloudnative-pg.io
                  parameters:
                    barmanObjectName: postgres17-minio
                cluster:
                  name: postgres17
              EOF

              # Wait for backup to start
              echo "Waiting for backup to start..."
              for i in {1..30}; do
                BACKUP_PHASE=$(kubectl get backup $BACKUP_NAME -n database -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
                if [ "$BACKUP_PHASE" = "running" ] || [ "$BACKUP_PHASE" = "completed" ]; then
                  echo "Backup started successfully (phase: $BACKUP_PHASE)"
                  break
                fi
                echo "Waiting... (attempt $i/30)"
                sleep 2
              done

              # Note: We don't wait for completion as backups can take a while
              # The backup will continue in the background
              echo "✓ Pre-sync backup initiated: $BACKUP_NAME"
              echo "=== Backup job completed ==="
