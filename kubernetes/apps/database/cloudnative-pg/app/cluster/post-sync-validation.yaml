---
# Post-sync hook to validate CNPG cluster health after updates
apiVersion: batch/v1
kind: Job
metadata:
  name: cnpg-post-sync-validation
  namespace: database
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: cnpg-validation
    spec:
      restartPolicy: Never
      serviceAccountName: postgres17
      containers:
        - name: validate
          image: alpine/k8s:1.35.1
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "=== CloudNative-PG Post-Sync Validation ==="
              echo "Timestamp: $(date -Iseconds)"

              # Wait for cluster to stabilize
              echo "Waiting 120 seconds for cluster to stabilize..."
              sleep 120

              # Check cluster status
              echo "Checking cluster status..."
              CLUSTER_STATUS=$(kubectl get cluster postgres17 -n database -o jsonpath='{.status.phase}')
              echo "Cluster phase: $CLUSTER_STATUS"

              if [ "$CLUSTER_STATUS" != "Cluster in healthy state" ]; then
                echo "✗ Cluster is not healthy: $CLUSTER_STATUS"
                exit 1
              fi

              # Check instance count
              INSTANCES=$(kubectl get cluster postgres17 -n database -o jsonpath='{.status.instances}')
              READY_INSTANCES=$(kubectl get cluster postgres17 -n database -o jsonpath='{.status.readyInstances}')
              echo "Instances: $READY_INSTANCES/$INSTANCES ready"

              if [ "$READY_INSTANCES" != "$INSTANCES" ]; then
                echo "✗ Not all instances are ready"
                exit 1
              fi

              # Check primary pod
              PRIMARY_POD=$(kubectl get cluster postgres17 -n database -o jsonpath='{.status.currentPrimary}')
              echo "Primary pod: $PRIMARY_POD"

              if [ -z "$PRIMARY_POD" ]; then
                echo "✗ No primary pod found"
                exit 1
              fi

              # Test database connectivity
              echo "Testing database connectivity..."
              if kubectl exec -n database $PRIMARY_POD -- psql -U postgres -c "SELECT version();" &>/dev/null; then
                echo "✓ Database is accepting connections"
              else
                echo "✗ Database is not accepting connections"
                exit 1
              fi

              # Check replication status
              echo "Checking replication status..."
              REPLICATION_COUNT=$(kubectl exec -n database $PRIMARY_POD -- psql -U postgres -t -c "SELECT count(*) FROM pg_stat_replication;" | tr -d ' ')
              EXPECTED_REPLICAS=$((INSTANCES - 1))
              echo "Replication slots: $REPLICATION_COUNT (expected: $EXPECTED_REPLICAS)"

              if [ "$REPLICATION_COUNT" != "$EXPECTED_REPLICAS" ]; then
                echo "⚠ Warning: Replication count mismatch (this may be temporary)"
              fi

              # Check WAL archiving status
              echo "Checking WAL archiving..."
              ARCHIVE_STATUS=$(kubectl get cluster postgres17 -n database -o jsonpath='{.status.continuousArchiving.lastSuccessfulBackup}')
              if [ -n "$ARCHIVE_STATUS" ]; then
                echo "✓ WAL archiving is active (last backup: $ARCHIVE_STATUS)"
              else
                echo "⚠ Warning: No recent WAL archive found"
              fi

              echo "=== All critical validation checks passed ==="

