---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app syslog-gateway
  namespace: &namespace observability
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controllers:
      main:
        containers:
          app:
            image:
              repository: cr.fluentbit.io/fluent/fluent-bit
              tag: 4.0.8
            args:
              - -c
              - /fluent-bit/etc/fluent-bit.conf
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                memory: 256Mi
    service:
      app:
        controller: main
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: 192.168.7.8
        ports:
          syslog-udp:
            port: 514
            protocol: UDP
          syslog-tcp:
            port: 514
            protocol: TCP
    persistence:
      config:
        type: configMap
        name: syslog-gateway-syslog-gateway-config
        globalMounts:
          - path: /fluent-bit/etc
    configMaps:
      syslog-gateway-config:
        data:
          fluent-bit.conf: |
            [SERVICE]
                Flush        5
                Daemon       Off
                Log_Level    info
                Parsers_File parsers.conf
            [INPUT]
                Name         syslog
                Mode         udp
                Listen       0.0.0.0
                Port         514
                Parser       syslog-rfc5424
                buffer_max_size 1M
                chunk_size   32k
                Tag          syslog.udp
            [INPUT]
                Name         syslog
                Mode         tcp
                Listen       0.0.0.0
                Port         514
                Parser       syslog-rfc5424
                buffer_max_size 1M
                chunk_size   32k
                Tag          syslog.tcp
            [FILTER]
                Name         record_modifier
                Match        syslog.*
                Record       cluster ${CLUSTER_NAME}
            [FILTER]
                Name         rewrite_tag
                Match        syslog.*
                Rule         $host ^(udm|udmpro|udm-pro|unifi.*|uap.*|usw.*|usg.*)$ unifi.$TAG false
            [OUTPUT]
                Name         opensearch
                Match        unifi.*
                Host         192.168.0.221
                Port         9200
                Index        logs-unifi
                Type         _doc
                Suppress_Type_Name On
                Logstash_Format On
                Logstash_Prefix logs-unifi
                Logstash_DateFormat %Y.%m.%d
                tls          Off
            [OUTPUT]
                Name         opensearch
                Match        syslog.*
                Host         192.168.0.221
                Port         9200
                Index        logs-syslog
                Type         _doc
                Suppress_Type_Name On
                Logstash_Format On
                Logstash_Prefix logs-syslog
                Logstash_DateFormat %Y.%m.%d
                tls          Off
          parsers.conf: |
            [PARSER]
                Name   syslog-rfc5424
                Format regex
                Regex  ^<(\d+)>\d\s+(?<host>[^\s]+)\s+(?<app>[^\s]+)\s+(?<procid>[^\s]+)\s+(?<msgid>[^\s]+)\s+(?<timestamp>[^\s]+)\s*(?<log>.*)$
                Time_Key   timestamp
                Time_Format %Y-%m-%dT%H:%M:%S.%L%z

