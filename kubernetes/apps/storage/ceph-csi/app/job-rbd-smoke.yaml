---
apiVersion: batch/v1
kind: Job
metadata:
  name: rbd-smoke
  namespace: storage
  labels:
    app: rbd-smoke
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app: rbd-smoke
    spec:
      restartPolicy: Never
      containers:
        - name: ceph-cli
          image: quay.io/ceph/ceph:v20.1.1
          imagePullPolicy: IfNotPresent
          env:
            - name: RBD_USER
              valueFrom:
                secretKeyRef:
                  name: csi-rbd-secret
                  key: userID
            - name: RBD_KEY
              valueFrom:
                secretKeyRef:
                  name: csi-rbd-secret
                  key: userKey
          command: ["/bin/sh","-c"]
          args:
            - |
              set -euxo pipefail
              echo "Testing rbd auth/connectivity..."
              rbd --version || true
              rados --version || true
              # Try simple pools list (may or may not be allowed by caps)
              rados --mon-host 192.168.3.90:6789,192.168.3.91:6789 -n client.${RBD_USER} --key "${RBD_KEY}" lspools || true
              # Attempt to list images in the target pool+namespace used by SC
              rbd --mon-host 192.168.3.90:6789,192.168.3.91:6789 --id "${RBD_USER}" --key "${RBD_KEY}" ls -p cephfs_containers --namespace k8s
              echo "OK"

