---
apiVersion: batch/v1
kind: Job
metadata:
  name: cephfs-create-smoke
  namespace: storage
  labels:
    app: cephfs-create-smoke
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app: cephfs-create-smoke
    spec:
      restartPolicy: Never
      containers:
        - name: ceph-cli
          image: quay.io/ceph/ceph:v18.2.4
          imagePullPolicy: IfNotPresent
          env:
            - name: ADMIN_ID
              valueFrom:
                secretKeyRef:
                  name: csi-cephfs-secret
                  key: adminID
            - name: ADMIN_KEY
              valueFrom:
                secretKeyRef:
                  name: csi-cephfs-secret
                  key: adminKey
          command: ["/bin/sh","-c"]
          args:
            - |
              set -euxo pipefail
              TS=$(date +%s)
              NAME="csi-cephfs-test-${TS}"
              echo "Writing minimal ceph.conf..."
              mkdir -p /etc/ceph
              cat >/etc/ceph/ceph.conf <<EOF
              [global]
              mon_host = 192.168.3.90:6789,192.168.3.91:6789
              EOF
              echo "Creating subvolume ${NAME} in group k8s..."
              ceph -n client.${ADMIN_ID} --key "${ADMIN_KEY}" fs subvolumegroup ls k8s || true
              ceph -n client.${ADMIN_ID} --key "${ADMIN_KEY}" fs subvolume create k8s "${NAME}" --group_name k8s --size 1073741824
              ceph -n client.${ADMIN_ID} --key "${ADMIN_KEY}" fs subvolume info k8s "${NAME}" --group_name k8s || true
              echo "Removing subvolume ${NAME}..."
              ceph -n client.${ADMIN_ID} --key "${ADMIN_KEY}" fs subvolume rm k8s "${NAME}" --group_name k8s
              echo "OK"

