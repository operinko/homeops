---
apiVersion: batch/v1
kind: Job
metadata:
  name: volsync-s3-init
  namespace: storage
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      containers:
      - name: s3-init
        image: minio/mc:latest
        command:
        - /bin/sh
        - -c
        - |
          # Configure Minio client
          mc alias set minio http://minio.storage.svc.cluster.local:9000 "$AWS_ACCESS_KEY_ID" "$AWS_SECRET_ACCESS_KEY"
          
          # Check if bucket exists, create if not
          if ! mc ls minio | grep -q volsync-backups; then
            echo "Creating volsync-backups bucket..."
            mc mb minio/volsync-backups
          else
            echo "Bucket volsync-backups already exists."
          fi
          
          # Set proper permissions
          mc policy set download minio/volsync-backups
          
          echo "S3 initialization completed successfully!"
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: volsync-s3-secret
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: volsync-s3-secret
              key: AWS_SECRET_ACCESS_KEY
      restartPolicy: Never
