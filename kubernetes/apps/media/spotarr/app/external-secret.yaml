---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: spotarr-secret
  namespace: media
spec:
  refreshInterval: 1h
  target:
    name: spotarr-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      data:
        # Usenet credentials (pass-through)
        USENET__USERNAME: "{{ .USENET__USERNAME }}"
        USENET__PASSWORD: "{{ .USENET__PASSWORD }}"
        USENET__HOSTNAME: "{{ .USENET__HOSTNAME }}"
        # Init container credentials (pass-through)
        POSTGRES_USER: "{{ .username }}"
        POSTGRES_PASSWORD: "{{ .password }}"
        INIT_POSTGRES_HOST: "{{ .postgres_host }}"
        INIT_POSTGRES_SUPER_USER: "{{ .INIT_POSTGRES_SUPER_USER }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .INIT_POSTGRES_SUPER_PASS }}"
        # Templated connection string with extended timeout for bulk imports
        DATABASE__CONNECTIONSTRING: "Host={{ .postgres_host }};Port=5432;Database={{ .postgres_db }};Username={{ .username }};Password={{ .password }};Command Timeout=120"
  data:
    # Usenet credentials
    - secretKey: USENET__USERNAME
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: usenet_user
    - secretKey: USENET__PASSWORD
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: usenet_password
    - secretKey: USENET__HOSTNAME
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: usenet_host

    # PostgreSQL credentials for spotarr user (from spotarr-secret Bitwarden item)
    # Used by init container and templated connection string
    - secretKey: username
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: username
    - secretKey: password
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: password
    - secretKey: postgres_host
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: ed32aa71-d74b-43bc-a467-aaa2569f532f
        property: init_postgres_host
    - secretKey: postgres_db
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: postgres_db

    # Init container credentials (for creating database)
    - secretKey: POSTGRES_USER
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: username
    - secretKey: POSTGRES_PASSWORD
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: 67fc83f9-aaf4-4b70-8150-19524e7b34e3
        property: password
    - secretKey: INIT_POSTGRES_HOST
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: ed32aa71-d74b-43bc-a467-aaa2569f532f
        property: init_postgres_host

    # CloudNative-PG superuser credentials (for init container)
    - secretKey: INIT_POSTGRES_SUPER_USER
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: ed32aa71-d74b-43bc-a467-aaa2569f532f
        property: username
    - secretKey: INIT_POSTGRES_SUPER_PASS
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: ed32aa71-d74b-43bc-a467-aaa2569f532f
        property: password
