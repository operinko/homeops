---
apiVersion: batch/v1
kind: Job
metadata:
  name: radarr-proper-migration
  namespace: media
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      containers:
      - name: migration
        image: alpine:latest
        command: 
        - /bin/sh
        - -c
        - |
          # Install SQLite for database operations
          apk add --no-cache sqlite
          
          echo "Starting Radarr migration..."
          
          # Create directories if they don't exist
          mkdir -p /destination
          mkdir -p /destination-cache
          
          echo "Copying non-database files from config volume..."
          # Copy everything except the database files
          find /source -type f -not -name "*.db*" -exec cp -av {} /destination \;
          
          echo "Creating a proper backup of the Radarr database..."
          # Create a proper backup of the database using SQLite
          if [ -f /source/radarr.db ]; then
            echo "Found radarr.db, creating backup..."
            sqlite3 /source/radarr.db ".backup '/destination/radarr.db'"
            echo "Database backup completed."
          else
            echo "ERROR: radarr.db not found in source directory!"
            exit 1
          fi
          
          echo "Copying cache files..."
          # Copy cache files
          cp -av /source-cache/* /destination-cache/
          
          echo "Migration completed successfully!"
        volumeMounts:
        - name: source
          mountPath: /source
        - name: destination
          mountPath: /destination
        - name: source-cache
          mountPath: /source-cache
        - name: destination-cache
          mountPath: /destination-cache
      volumes:
      - name: source
        persistentVolumeClaim:
          claimName: radarr
      - name: destination
        persistentVolumeClaim:
          claimName: radarr-mayastor
      - name: source-cache
        persistentVolumeClaim:
          claimName: radarr-cache
      - name: destination-cache
        persistentVolumeClaim:
          claimName: radarr-cache-mayastor
      restartPolicy: Never
