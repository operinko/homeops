---
# Temporary Job to bind VolSync cache PVCs for WaitForFirstConsumer storage class
# This job mounts the cache PVCs created by ReplicationDestination to trigger binding,
# then immediately exits, allowing VolSync to proceed with the restore operation.
apiVersion: batch/v1
kind: Job
metadata:
  name: headlamp-volsync-pvc-binder
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "1"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: pvc-binder
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Binding VolSync cache PVCs..."
              echo "Cache PVC mounted at /cache"
              echo "Dest PVC mounted at /dest"
              ls -la /cache /dest
              echo "PVCs bound successfully. Exiting."
          volumeMounts:
            - name: cache
              mountPath: /cache
            - name: dest
              mountPath: /dest
      volumes:
        - name: cache
          persistentVolumeClaim:
            claimName: volsync-dst-headlamp-dst-cache
        - name: dest
          persistentVolumeClaim:
            claimName: volsync-headlamp-dst-dest

