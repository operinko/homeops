---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: headlamp
spec:
  accessModes: ["ReadWriteOnce"]
  dataSourceRef:
    kind: ReplicationDestination
    apiGroup: volsync.backube
    name: headlamp-dst
  resources:
    requests:
      storage: 1Gi
  storageClassName: ceph-rbd
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/volsync.backube/replicationsource_v1alpha1.json
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: headlamp
spec:
  sourcePVC: headlamp
  trigger:
    schedule: "0 * * * *"
  restic:
    copyMethod: Snapshot
    pruneIntervalDays: 14
    repository: headlamp-volsync-secret
    volumeSnapshotClassName: csi-rbd-snapclass
    cacheCapacity: 5Gi
    cacheStorageClassName: ceph-rbd
    cacheAccessModes: ["ReadWriteOnce"]
    storageClassName: ceph-rbd
    accessModes: ["ReadWriteOnce"]
    moverSecurityContext:
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
    retain:
      hourly: 24
      daily: 7
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/volsync.backube/replicationdestination_v1alpha1.json
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: headlamp-dst
  annotations:
    argocd.argoproj.io/sync-wave: "0"
  labels:
    kustomize.toolkit.fluxcd.io/ssa: IfNotPresent
spec:
  trigger:
    manual: restore-once
  restic:
    repository: headlamp-volsync-secret
    copyMethod: Snapshot
    volumeSnapshotClassName: csi-rbd-snapclass
    cacheStorageClassName: ceph-rbd
    cacheAccessModes: ["ReadWriteOnce"]
    cacheCapacity: 5Gi
    storageClassName: ceph-rbd
    accessModes: ["ReadWriteOnce"]
    capacity: 1Gi
    moverSecurityContext:
      runAsUser: 65534
      runAsGroup: 65534
      fsGroup: 65534
    enableFileDeletion: true
    cleanupCachePVC: true
    cleanupTempPVC: true
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: headlamp-volsync-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-field
    kind: ClusterSecretStore
  target:
    name: headlamp-volsync-secret
    template:
      engineVersion: v2
      data:
        RESTIC_REPOSITORY: "{{ .restic_repository }}headlamp"
        RESTIC_PASSWORD: "{{ .restic_password }}"
        AWS_ACCESS_KEY_ID: "{{ .aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ .aws_secret_access_key }}"
        AWS_DEFAULT_REGION: "{{ .aws_default_region }}"
        AWS_REGION: "{{ .aws_region }}"
        AWS_S3_FORCE_PATH_STYLE: "{{ .aws_s3_force_path_style }}"
        AWS_ENDPOINT: "{{ .aws_endpoint }}"
  data:
    - secretKey: restic_repository
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: restic_repository
    - secretKey: restic_password
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: restic_password
    - secretKey: aws_access_key_id
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: aws_access_key_id
    - secretKey: aws_secret_access_key
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: aws_secret_access_key
    - secretKey: aws_default_region
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: aws_default_region
    - secretKey: aws_region
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: aws_region
    - secretKey: aws_s3_force_path_style
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: aws_s3_force_path_style
    - secretKey: aws_endpoint
      remoteRef:
        key: cf4b996c-1bff-4d1a-b95d-9de3995ddc71
        property: aws_endpoint

