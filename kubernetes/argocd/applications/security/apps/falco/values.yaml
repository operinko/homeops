---
# Helm values for falco deployment
# Runtime security monitoring with eBPF

# Driver configuration - use modern eBPF (no kernel headers needed)
driver:
  enabled: true
  kind: modern_ebpf
  ebpf:
    # Modern eBPF driver is built-in, no need for init container
    enabled: true

# Falco configuration
falco:
  # Log level
  log_level: info

  # Output channels
  json_output: true
  json_include_output_property: true
  json_include_tags_property: true

  # File output disabled (we use gRPC to Falcosidekick)
  file_output:
    enabled: false

  # Program output disabled
  program_output:
    enabled: false

  # HTTP output disabled (using gRPC)
  http_output:
    enabled: false

  # gRPC server using Unix socket (no mTLS needed)
  grpc:
    enabled: true
    bind_address: "unix:///run/falco/falco.sock"
    threadiness: 0

  # gRPC output
  grpc_output:
    enabled: true

  # Syscall event drops
  syscall_event_drops:
    actions:
      - log
      - alert
    rate: 0.03333
    max_burst: 1

  # Rules (use plural form - singular is deprecated)
  rules_files:
    - /etc/falco/falco_rules.yaml
    - /etc/falco/falco_rules.local.yaml
    - /etc/falco/rules.d

# Falcosidekick integration - bundled with Falco
falcosidekick:
  enabled: true
  fullfqdn: true

  # Falcosidekick configuration (subchart values)
  config:
    # Use existing secret for credentials
    existingSecret: "falcosidekick-secret"

    # Disable debug logging (no longer needed)
    debug: false

    # Elastic Agent TCP output (Falco integration listener)
    # Elastic Agent will ingest events and push to Elasticsearch with proper formatting
    elasticagent:
      hostport: "elastic-agent-falco.observability.svc.cluster.local:9030"
      minimumpriority: "debug"

    # Discord output (will be configured via secret)
    discord:
      webhookurl: ""
      minimumpriority: "warning"

    # Pushover output (will be configured via secret)
    pushover:
      userkey: ""
      apitoken: ""
      minimumpriority: "warning"

    # Custom fields
    customfields: "cluster:homelab,environment:production"

  # Web UI - Disabled (using Kibana with Elastic Falco integration instead)
  webui:
    enabled: false

  # Security context
  podSecurityContext:
    runAsUser: 1234
    fsGroup: 1234



# Resources
resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    memory: 1Gi

# Tolerations - run on all nodes
tolerations:
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane
  - effect: NoSchedule
    key: node-role.kubernetes.io/master

# Priority
priorityClassName: system-node-critical

# Service Account
serviceAccount:
  create: true
  name: falco

# RBAC
rbac:
  create: true

# Pod Security
podSecurityPolicy:
  create: false

# Pod Security Context
podSecurityContext:
  runAsNonRoot: false
  runAsUser: 0

# Container Security Context
securityContext:
  privileged: false
  capabilities:
    add:
      - SYS_PTRACE
      - SYS_ADMIN

# Metrics
metrics:
  enabled: true
  interval: 1h

# Service Monitor for Prometheus
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s

# Custom rules - Disable noisy rules for homelab
customRules:
  homelab-exceptions.yaml: |-
    # Custom Falco rules for homelab environment
    # Disable the CNI binary alert rule (too noisy in Talos/Cilium environment)

    # Disable the rule entirely
    - rule: Executing binary not part of base image
      enabled: false

# Falco configuration overrides
falcoctl:
  artifact:
    install:
      enabled: true
    follow:
      enabled: true
  config:
    artifact:
      allowedTypes:
        - rulesfile
        - plugin
      install:
        resolveDeps: true
        refs:
          - falco-rules:3
      follow:
        refs:
          - falco-rules:3

