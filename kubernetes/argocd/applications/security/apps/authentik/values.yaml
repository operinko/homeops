global:
  deploymentAnnotations:
    secret.reloader.stakater.com/reload: authentik-secret
  env:
    - name: AUTHENTIK_SESSION_STORAGE
      value: db
    # Increase gunicorn worker limits to prevent "Maximum request limit exceeded" errors
    - name: WORKERS
      value: "4"
    - name: WEB_CONCURRENCY
      value: "4"
  envFrom:
    - secretRef:
        name: authentik-secret
server:
  replicas: 2  # Increased from 1 to handle auth load better
  initContainers:
    - name: init-db
      image: ghcr.io/home-operations/postgres-init:17.6
      envFrom:
        - secretRef:
            name: authentik-secret
  resources:
    requests:
      cpu: 50m
      memory: 500Mi
    limits:
      memory: 800Mi
  livenessProbe:
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5
  readinessProbe:
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6
  startupProbe:
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 90
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
  service:
    enabled: true
    type: LoadBalancer
    externalTrafficPolicy: Local
    watchedResources: ["Ingress", "Service"]
    annotations:
      lbipam.cilium.io/ips: "192.168.7.10"
  ingress:
    enabled: false
worker:
  replicas: 3
  resources:
    requests:
      cpu: 50m
      memory: 500Mi
    limits:
      memory: 1200Mi
  # Worker probes - increase timeout for healthcheck command
  livenessProbe:
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 5
  readinessProbe:
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3
  startupProbe:
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 10
    failureThreshold: 30
authentik:
  log_level: info
  secret_key: authentik-secret
  redis:
    host: dragonfly.database.svc.cluster.local
  error_reporting:
    enabled: false
prometheus:
  rules:
    enabled: true

