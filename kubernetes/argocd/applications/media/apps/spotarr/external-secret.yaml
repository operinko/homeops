---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: spotarr-secret
  namespace: media
spec:
  refreshInterval: 1h
  target:
    name: spotarr-secret
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      engineVersion: v2
      data:
        # Usenet credentials (pass-through)
        USENET__USERNAME: "{{ .USENET__USERNAME }}"
        USENET__PASSWORD: "{{ .USENET__PASSWORD }}"
        USENET__HOSTNAME: "{{ .USENET__HOSTNAME }}"
        # Init container credentials (pass-through)
        POSTGRES_USER: "{{ .username }}"
        POSTGRES_PASSWORD: "{{ .password }}"
        INIT_POSTGRES_HOST: "{{ .postgres_host }}"
        INIT_POSTGRES_SUPER_USER: "{{ .INIT_POSTGRES_SUPER_USER }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .INIT_POSTGRES_SUPER_PASS }}"
        # Templated connection string with extended timeout for bulk imports
        DATABASE__CONNECTIONSTRING: "Host={{ .postgres_host }};Port=5432;Database={{ .postgres_db }};Username={{ .username }};Password={{ .password }};Command Timeout=120"
  data:
    # Usenet credentials
    - secretKey: USENET__USERNAME
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: 15b18bb7-868d-4a6b-9ddf-43261a93a326
        property: username
    - secretKey: USENET__PASSWORD
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: 15b18bb7-868d-4a6b-9ddf-43261a93a326
        property: password
    - secretKey: USENET__HOSTNAME
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: 15b18bb7-868d-4a6b-9ddf-43261a93a326
        property: hostname

    # PostgreSQL credentials for spotarr user (from spotarr-secret Bitwarden item)
    # Used by init container and templated connection string
    - secretKey: username
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: username
    - secretKey: password
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: password
    - secretKey: postgres_host
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: postgres_host
    - secretKey: postgres_db
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: postgres_db

    # Init container credentials (for creating database)
    - secretKey: POSTGRES_USER
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: username
    - secretKey: POSTGRES_PASSWORD
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: password
    - secretKey: INIT_POSTGRES_HOST
      sourceRef:
        storeRef:
          name: bitwarden-fields
          kind: ClusterSecretStore
      remoteRef:
        key: de808be7-3e45-4d13-8de3-1b448857bb1a
        property: postgres_host

    # CloudNative-PG superuser credentials (for init container)
    - secretKey: INIT_POSTGRES_SUPER_USER
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: c1b5bc1c-2635-4be4-9bfa-ad755db3daa0
        property: username
    - secretKey: INIT_POSTGRES_SUPER_PASS
      sourceRef:
        storeRef:
          name: bitwarden-login
          kind: ClusterSecretStore
      remoteRef:
        key: c1b5bc1c-2635-4be4-9bfa-ad755db3daa0
        property: password

