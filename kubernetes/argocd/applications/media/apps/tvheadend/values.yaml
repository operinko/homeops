---
# Helm values for tvheadend app-template deployment
controllers:
  tvheadend:
    pod:
      annotations:
        # FritzBox SAT>IP limitation: one tuner connection per source IP
        # Create 4 macvlan interfaces with different IPs for 4 tuners
        k8s.v1.cni.cncf.io/networks: |
          [
            {
              "name": "macvlan-satip",
              "namespace": "media",
              "ips": ["192.168.7.81/24"],
              "gateway": ["192.168.7.1"],
              "mac": "02:00:00:00:00:81"
            },
            {
              "name": "macvlan-satip",
              "namespace": "media",
              "ips": ["192.168.7.82/24"],
              "gateway": ["192.168.7.1"],
              "mac": "02:00:00:00:00:82"
            },
            {
              "name": "macvlan-satip",
              "namespace": "media",
              "ips": ["192.168.7.83/24"],
              "gateway": ["192.168.7.1"],
              "mac": "02:00:00:00:00:83"
            },
            {
              "name": "macvlan-satip",
              "namespace": "media",
              "ips": ["192.168.7.84/24"],
              "gateway": ["192.168.7.1"],
              "mac": "02:00:00:00:00:84"
            }
          ]
    initContainers:
      setup-routing:
        image:
          repository: alpine
          tag: "3.20"
        command:
          - /bin/sh
          - -c
          - |
            # Install iproute2 for advanced routing
            apk add --no-cache iproute2

            # Create routing tables for each macvlan interface
            # This ensures traffic from each IP uses the correct interface
            echo "100 satip1" >> /etc/iproute2/rt_tables
            echo "101 satip2" >> /etc/iproute2/rt_tables
            echo "102 satip3" >> /etc/iproute2/rt_tables
            echo "103 satip4" >> /etc/iproute2/rt_tables

            # Add rules to use specific routing tables based on source IP
            ip rule add from 192.168.7.81 table satip1 prio 100
            ip rule add from 192.168.7.82 table satip2 prio 101
            ip rule add from 192.168.7.83 table satip3 prio 102
            ip rule add from 192.168.7.84 table satip4 prio 103

            # Add default routes in each table via the respective interface
            ip route add default via 192.168.7.1 dev net1 table satip1
            ip route add default via 192.168.7.1 dev net2 table satip2
            ip route add default via 192.168.7.1 dev net3 table satip3
            ip route add default via 192.168.7.1 dev net4 table satip4

            echo "Policy routing configured for SAT>IP interfaces"
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
    containers:
      tvheadend:
        image:
          repository: registry.skysolutions.fi/library/tvheadend
          tag: 4.3.10368@sha256:66e019f04260fc784c3fd8d67a5575309935eb99c5e1f312f6fff8f4261494a2
        command: ["/entrypoint.sh"]
        args:
          - "--noacl"
          - "--satip_xml"
          - "http://192.168.0.81:49000/satipdesc.xml"
        env:
          TZ: "Europe/Helsinki"
        securityContext:
          privileged: true
defaultPodOptions:
  securityContext:
    runAsUser: 568
    runAsGroup: 568
    fsGroup: 568
    fsGroupChangePolicy: "OnRootMismatch"
    supplementalGroups:
      - 44
      - 212
      - 109
service:
  tvheadend:
    controller: tvheadend
    type: LoadBalancer
    ports:
      http:
        port: &port 9981
      htsp:
        port: 9982
persistence:
  config:
    enabled: true
    existingClaim: tvheadend
    globalMounts:
      - path: /config
  recordings:
    enabled: true
    type: nfs
    server: 192.168.0.221
    path: /mnt/Nakkiallas/Media/recordings
    globalMounts:
      - path: /recordings
  timeshift:
    enabled: true
    type: emptyDir
    globalMounts:
      - path: /timeshift
  dev:
    enabled: true
    type: hostPath
    hostPath: /dev/
    globalMounts:
      - path: /dev/
resources:
  requests:
    cpu: 100m
    memory: 20Mi
  limits:
    cpu: 1000m
    memory: 1096Mi
