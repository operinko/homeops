---
# Helm values for lingarr app-template deployment
controllers:
  lingarr:
    annotations:
      reloader.stakater.com/auto: "true"
    initContainers:
      init-db:
        image:
          repository: ghcr.io/cloudnative-pg/postgresql
          tag: 17.2-12
        command:
          - sh
          - -c
          - |
            until pg_isready -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER}; do
              echo "Waiting for PostgreSQL to be ready..."
              sleep 2
            done
            echo "PostgreSQL is ready, creating database and user if they don't exist..."

            # Create database if it doesn't exist
            PGPASSWORD=${POSTGRES_SUPER_PASS} psql -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER} -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'lingarr'" | grep -q 1 || \
            PGPASSWORD=${POSTGRES_SUPER_PASS} psql -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER} -d postgres -c "CREATE DATABASE lingarr"

            # Create user if it doesn't exist
            PGPASSWORD=${POSTGRES_SUPER_PASS} psql -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER} -d postgres -tc "SELECT 1 FROM pg_roles WHERE rolname = '${DB_USERNAME}'" | grep -q 1 || \
            PGPASSWORD=${POSTGRES_SUPER_PASS} psql -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER} -d postgres -c "CREATE USER ${DB_USERNAME} WITH PASSWORD '${DB_PASSWORD}'"

            # Grant privileges
            PGPASSWORD=${POSTGRES_SUPER_PASS} psql -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER} -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE lingarr TO ${DB_USERNAME}"
            PGPASSWORD=${POSTGRES_SUPER_PASS} psql -h postgres17.database.svc.cluster.local -p 5432 -U ${POSTGRES_SUPER_USER} -d lingarr -c "GRANT ALL ON SCHEMA public TO ${DB_USERNAME}"

            echo "Database setup complete"
        envFrom:
          - secretRef:
              name: lingarr-db-secret
    containers:
      app:
        image:
          repository: lingarr/lingarr
          tag: latest
        env:
          TZ: Europe/Helsinki
          ASPNETCORE_URLS: http://+:9876
          DB_CONNECTION: mysql
          DB_HOST: postgres17.database.svc.cluster.local
          DB_PORT: "5432"
          DB_DATABASE: lingarr
        envFrom:
          - secretRef:
              name: lingarr-db-secret
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: &port 9876
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 10
              failureThreshold: 3
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: *port
              initialDelaySeconds: 15
              periodSeconds: 10
              timeoutSeconds: 10
              failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: ["ALL"] }
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 1Gi
defaultPodOptions:
  securityContext:
    runAsNonRoot: true
    runAsUser: 568
    runAsGroup: 568
    fsGroup: 568
    fsGroupChangePolicy: OnRootMismatch
    seccompProfile: { type: RuntimeDefault }
service:
  app:
    controller: lingarr
    ports:
      http:
        port: *port
persistence:
  config:
    existingClaim: lingarr
    globalMounts:
      - path: /app/config
  media:
    type: nfs
    server: 192.168.0.221
    path: /mnt/Nakkiallas/Media
    globalMounts:
      - path: /media
  tmp:
    type: emptyDir

