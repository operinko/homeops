---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  project: network
  source:
    repoURL: https://traefik.github.io/charts
    chart: traefik
    targetRevision: 37.2.0
    helm:
      valuesObject:
        gateway:
          enabled: false
        gatewayClass:
          enabled: false

        # Progressive rollout strategy: update one pod at a time
        deployment:
          replicas: 3  # Increased from 2 for better load distribution
          strategy:
            type: RollingUpdate
            rollingUpdate:
              maxSurge: 1
              maxUnavailable: 0

        # Resource limits for proper scheduling and performance
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 1000m
            memory: 512Mi

        additionalArguments:
          - --api.insecure=true
          - --api.dashboard=true
          # Performance tuning
          - --serversTransport.maxIdleConnsPerHost=100
          - --entryPoints.websecure.transport.respondingTimeouts.readTimeout=60s
          - --entryPoints.websecure.transport.respondingTimeouts.writeTimeout=60s
          - --entryPoints.websecure.transport.respondingTimeouts.idleTimeout=180s

        podAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "9100"
        providers:
          kubernetesIngress:
            enabled: false
            namespaces: []
          kubernetesGateway:
            enabled: true
            statusAddress:
              ip: "192.168.7.4"
            controllerName: traefik.io/gateway-controller
            endpointSlice: true
          kubernetesCRD:
            enabled: true
            endpointSlice: true
        api:
          dashboard: true
          insecure: true
        logs:
          general:
            level: INFO
          access:
            enabled: true
            format: json
            fields:
              defaultMode: keep
              names:
                ClientUsername: drop
              headers:
                defaultMode: keep
                names:
                  Authorization: drop
                  User-Agent: keep
                  CF-Connecting-IP: keep
                  X-Forwarded-For: keep
                  X-Real-IP: keep
                  X-Forwarded-Host: keep
                  X-Forwarded-Port: keep
                  X-Forwarded-Proto: keep
        experimental:
          plugins:
            authentik-forward:
              moduleName: "github.com/xabinapal/traefik-authentik-forward-plugin"
              version: "v1.0.0"
            bouncer:
              moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
              version: "v1.4.5"
            traefikwarp:
              moduleName: "github.com/l4rm4nd/traefik-warp"
              version: "v1.1.5"
        volumes:
          - name: traefik-crowdsec-bouncer
            type: secret
            mountPath: /var/run/secrets/crowdsec
          - name: traefik-crowdsec-pages
            type: configMap
            mountPath: /etc/traefik/crowdsec
        additionalVolumeMounts:
          - name: traefik-crowdsec-pages
            mountPath: /captcha.html
            subPath: captcha.html
            readOnly: true
        service:
          enabled: true
          type: LoadBalancer
          annotations:
            lbipam.cilium.io/ips: "192.168.7.4"
          externalTrafficPolicy: Local  # Changed from Cluster to reduce network hops
        ports:
          web:
            port: 80
          websecure:
            port: 443
            tls:
              enabled: true
            # HTTP/2 and HTTP/3 configuration
            http3:
              enabled: true
          traefik:
            port: 9000
            expose:
              default: true
            exposedPort: 9000
  destination:
    server: https://kubernetes.default.svc
    namespace: network
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
    # Progressive sync: update Traefik pods one at a time
    # This ensures zero-downtime updates for the ingress controller
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

