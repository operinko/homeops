---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  project: network
  source:
    repoURL: https://traefik.github.io/charts
    chart: traefik
    targetRevision: 37.2.0
    helm:
      valuesObject:
        gateway:
          enabled: false
        gatewayClass:
          enabled: false

        additionalArguments:
          - --api.insecure=true
          - --api.dashboard=true

        podAnnotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "9100"
        providers:
          kubernetesIngress:
            enabled: false
            namespaces: []
          kubernetesGateway:
            enabled: true
            statusAddress:
              ip: "192.168.7.4"
            controllerName: traefik.io/gateway-controller
            endpointSlice: true
          kubernetesCRD:
            enabled: true
            endpointSlice: true
        api:
          dashboard: true
          insecure: true
        logs:
          general:
            level: INFO
          access:
            enabled: true
            format: json
            fields:
              defaultMode: keep
              names:
                ClientUsername: drop
              headers:
                defaultMode: keep
                names:
                  Authorization: drop
                  User-Agent: keep
                  CF-Connecting-IP: keep
                  X-Forwarded-For: keep
                  X-Real-IP: keep
                  X-Forwarded-Host: keep
                  X-Forwarded-Port: keep
                  X-Forwarded-Proto: keep
        experimental:
          plugins:
            authentik-forward:
              moduleName: "github.com/xabinapal/traefik-authentik-forward-plugin"
              version: "v1.0.0"
            bouncer:
              moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
              version: "v1.4.5"
        volumes:
          - name: traefik-crowdsec-bouncer
            type: secret
            mountPath: /var/run/secrets/crowdsec
          - name: traefik-crowdsec-pages
            type: configMap
            mountPath: /etc/traefik/crowdsec
        additionalVolumeMounts:
          - name: traefik-crowdsec-pages
            mountPath: /captcha.html
            subPath: captcha.html
            readOnly: true
        service:
          enabled: true
          type: LoadBalancer
          annotations:
            lbipam.cilium.io/ips: "192.168.7.4"
          externalTrafficPolicy: Cluster
        ports:
          web:
            port: 80
          websecure:
            port: 443
            tls:
              enabled: true
          traefik:
            port: 9000
            expose:
              default: true
            exposedPort: 9000
  destination:
    server: https://kubernetes.default.svc
    namespace: network
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true

