---
# Post-sync hook to validate Traefik connectivity after deployment
apiVersion: batch/v1
kind: Job
metadata:
  name: traefik-post-sync-validation
  namespace: network
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      name: traefik-validation
    spec:
      restartPolicy: Never
      containers:
        - name: validate
          image: curlimages/curl:8.11.1
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "=== Traefik Post-Sync Validation ==="
              echo "Waiting 10 seconds for Traefik to stabilize..."
              sleep 10
              
              echo "Testing Traefik API endpoint..."
              if curl -f -s -o /dev/null -w "%{http_code}" http://traefik.network.svc.cluster.local:9000/api/overview | grep -q "200"; then
                echo "✓ Traefik API is responding"
              else
                echo "✗ Traefik API is not responding"
                exit 1
              fi
              
              echo "Testing Traefik dashboard..."
              if curl -f -s -o /dev/null -w "%{http_code}" http://traefik.network.svc.cluster.local:9000/dashboard/ | grep -q "200"; then
                echo "✓ Traefik dashboard is accessible"
              else
                echo "✗ Traefik dashboard is not accessible"
                exit 1
              fi
              
              echo "Testing Traefik service endpoint (port 80)..."
              if curl -f -s -o /dev/null -w "%{http_code}" http://traefik.network.svc.cluster.local:80 | grep -q "404"; then
                echo "✓ Traefik web endpoint is responding (404 expected for root)"
              else
                echo "✗ Traefik web endpoint is not responding"
                exit 1
              fi
              
              echo "=== All Traefik validation checks passed ==="

