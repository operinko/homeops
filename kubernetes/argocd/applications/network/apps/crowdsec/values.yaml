---
# Helm values for crowdsec deployment
container_runtime: containerd
secrets:
  externalSecret:
    name: crowdsec-secret
    csLapiSecretKey: csLapiSecret
    registrationTokenKey: registrationToken
lapi:
  envFrom:
    - secretRef:
        name: crowdsec-secret
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      memory: 512Mi
  readinessProbe: &probes
    initialDelaySeconds: 180  # Give more time for initial startup
    periodSeconds: 10
    timeoutSeconds: 10  # Increased from 5s
    failureThreshold: 60
  livenessProbe: *probes
  service:
    type: ClusterIP
  persistentVolume:
    data:
      enabled: true
      existingClaim: crowdsec
    config:
      enabled: true
      storageClassName: ceph-rbd
      size: 100Mi
  # Database performance tuning
  env:
    - name: CAPI_WHITELISTS_URL
      value: ""
    - name: DISABLE_ONLINE_API
      value: "false"
    # Increase database connection pool and timeout
    - name: CROWDSEC_DB_MAX_OPEN_CONNS
      value: "100"
    - name: CROWDSEC_DB_MAX_IDLE_CONNS
      value: "25"
    - name: CROWDSEC_DB_CONN_MAX_LIFETIME
      value: "500ms"
agent:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi
  acquisition:
    - namespace: network
      podName: "traefik-*"
      program: "traefik"
  env:
    - name: COLLECTIONS
      value: "crowdsecurity/traefik"
    # Reduce log noise from parsing warnings
    - name: LEVEL_TRACE
      value: "false"
    - name: LEVEL_DEBUG
      value: "false"
  metrics:
    enabled: true
  # Agents need much longer to initialize (download hub, register, start)
  # Note: CrowdSec chart doesn't support 'enabled' field in probes
  readinessProbe: *probes
  livenessProbe: *probes
  startupProbe: *probes
