---
# Helm values for technitium deployment
controllers:
  technitium:
    strategy: Recreate
    pod:
      hostname: ns1
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [
            {
              "name": "macvlan-vlan7",
              "namespace": "network",
              "ips": ["192.168.7.8/24"],
              "gateway": ["192.168.7.1"]
            }
          ]
    initContainers:
      mk-pfx:
        image:
          repository: alpine/openssl
          tag: "3.5.4"
          pullPolicy: IfNotPresent
        command:
          - sh
          - -c
          - >-
            openssl pkcs12 -export -legacy -out /etc/dns/ssl.pfx -inkey /certs/tls.key -in /certs/tls.crt -passout pass:
    containers:
      app:
        image:
          repository: technitium/dns-server
          tag: 14.1.0
        envFrom:
          - secretRef:
              name: technitium-secret
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities: { drop: ["ALL"] }
        resources:
          requests:
            cpu: 200m
            memory: 800Mi
          limits:
            cpu: 1000m
            memory: 2000Mi
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    # Check if DNS server responds to queries
                    # Using dig to query localhost for a test record
                    timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 10
              failureThreshold: 3
          readiness:
            enabled: true
            custom: true
            spec:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    # Check if DNS server responds to queries
                    timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          startup:
            enabled: true
            custom: true
            spec:
              exec:
                command:
                  - sh
                  - -c
                  - |
                    # Check if DNS server responds to queries
                    timeout 5 dig @127.0.0.1 -p 53 google.com +short > /dev/null 2>&1
              initialDelaySeconds: 5
              periodSeconds: 5
              timeoutSeconds: 5
              failureThreshold: 30
defaultPodOptions:
  automountServiceAccountToken: false
  enableServiceLinks: false
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    fsGroupChangePolicy: "OnRootMismatch"
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
service:
  technitium:
    controller: technitium
    ports:
      http:
        port: 5380
  # Headless service for FQDN resolution (ns1.dns-vaderrp-com.network.svc.cluster.local)
  dns-vaderrp-com:
    controller: technitium
    type: ClusterIP
    clusterIP: None
    ports:
      http:
        port: 5380
  # Individual node LoadBalancer IP
  ns1:
    controller: technitium
    type: LoadBalancer
    annotations:
      lbipam.cilium.io/ips: "192.168.7.8"
    ports:
      dns-tcp:
        enabled: true
        port: 53
        protocol: TCP
      dns-udp:
        enabled: true
        port: 53
        protocol: UDP
      dns-dot:
        enabled: true
        port: 853
        protocol: TCP
      dns-doh-http:
        enabled: true
        port: 80
        protocol: TCP
      dns-doh:
        enabled: true
        port: 443
        protocol: TCP
  # Shared cluster VIP (will be reconfigured for load balancing in Phase 4)
  dns:
    controller: technitium
    type: LoadBalancer
    annotations:
      lbipam.cilium.io/ips: "192.168.7.7"
    ports:
      dns-tcp:
        enabled: true
        port: 53
        protocol: TCP
      dns-udp:
        enabled: true
        port: 53
        protocol: UDP
      dns-dot:
        enabled: true
        port: 853
        protocol: TCP
      dns-doh-http:
        enabled: true
        port: 80
        protocol: TCP
      dns-doh:
        enabled: true
        port: 443
        protocol: TCP
persistence:
  config:
    existingClaim: technitium
    globalMounts:
      - path: /etc/dns
  tls-secret:
    type: secret
    name: vaderrp-com-production-tls
    globalMounts:
      - path: /certs
        readOnly: true
