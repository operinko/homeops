---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: argocd
  source:
    repoURL: https://argoproj.github.io/argo-helm
    targetRevision: 9.1.0
    chart: argo-cd
    helm:
        values: |
          global:
            domain: argocd.vaderrp.com
          server:
            certificateSecret:
              enabled: false
            config:
              url: https://argocd.vaderrp.com
              dex.config: |
                connectors:
                - type: oidc
                  id: authentik
                  name: authentik
                  config:
                    issuer: https://auth.vaderrp.com/application/o/argocd/
                    clientID: sizSMIPV1FzETNbe25zeU9zsOuusbFXRqqQF9o0C
                    clientSecret: $dex.authentik.clientSecret
                    insecureEnableGroups: true
                    scopes:
                      - openid
                      - profile
                      - email
            ingress:
              enabled: false
            httproute:
              enabled: false
            grpcroute:
              enabled: false
            backendTLSPolicy:
              enabled: false
          controller:
            replicas: 1
          repoServer:
            replicas: 2
          server:
            replicas: 2
          applicationSet:
            enabled: true
            replicas: 2
          notifications:
            enabled: false
          redis:
            enabled: true
          configs:
            cm:
              exec.enabled: "true"
              resource.customizations.health.helm.toolkit.fluxcd.io_HelmRelease: |
                hs = {}
                if obj.status ~= nil then
                  if obj.status.conditions ~= nil then
                    for i, condition in ipairs(obj.status.conditions) do
                      if condition.type == "Ready" and condition.status == "False" then
                        hs.status = "Degraded"
                        hs.message = condition.message
                        return hs
                      end
                      if condition.type == "Ready" and condition.status == "True" then
                        hs.status = "Healthy"
                        hs.message = condition.message
                        return hs
                      end
                    end
                  end
                end
                hs.status = "Progressing"
                hs.message = "Waiting for HelmRelease"
                return hs
            params:
              controller.diff.server.side: "true"
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: false
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - RespectIgnoreDifferences=true
      - ServerSideApply=true
  ignoreDifferences:
    # Ignore HelmRelease status and labels changes
    - group: helm.toolkit.fluxcd.io
      kind: HelmRelease
      jsonPointers:
        - /status
        - /metadata/labels
    # Ignore ArgoCD-managed labels on all resources
    - group: "*"
      kind: "*"
      jsonPointers:
        - /metadata/labels/argocd.argoproj.io~1instance
    # Ignore ArgoCD server deployment changes (managed by Helm)
    - group: apps
      kind: Deployment
      name: argocd-server
      jsonPointers:
        - /spec/replicas
    # Ignore ArgoCD repo-server deployment changes (managed by Helm)
    - group: apps
      kind: Deployment
      name: argocd-repo-server
      jsonPointers:
        - /spec/template/spec/containers
        - /spec/template/spec/volumes

