---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: argocd
  sources:
    - repoURL: https://argoproj.github.io/argo-helm
      targetRevision: 9.1.0
      chart: argo-cd
      helm:
        values: |
          global:
            domain: argocd.vaderrp.com
          server:
            certificateSecret:
              enabled: false
            config:
              url: https://argocd.vaderrp.com
              dex.config: |
                connectors:
                - type: oidc
                  id: authentik
                  name: authentik
                  config:
                    issuer: https://auth.vaderrp.com/application/o/argocd/
                    clientID: sizSMIPV1FzETNbe25zeU9zsOuusbFXRqqQF9o0C
                    clientSecret: $dex.authentik.clientSecret
                    insecureEnableGroups: true
                    scopes:
                      - openid
                      - profile
                      - email
            ingress:
              enabled: false
            httproute:
              enabled: false
            grpcroute:
              enabled: false
            backendTLSPolicy:
              enabled: false
          controller:
            replicas: 1
          repoServer:
            replicas: 2
          server:
            replicas: 2
          applicationSet:
            enabled: true
            replicas: 2
          notifications:
            enabled: true
            replicas: 1
            notifiers:
              service.webhook.discord: |
                url: $discord-webhook
                headers:
                - name: Content-Type
                  value: application/json
              service.pushover: |
                token: $pushover-token
                user: $pushover-user
            subscriptions:
              - recipients:
                  - discord
                triggers:
                  - on-deployed
                  - on-health-degraded
                  - on-sync-failed
                  - on-sync-succeeded
            triggers:
              trigger.on-deployed: |
                - description: Application is synced and healthy
                  send:
                  - app-deployed
                  when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'
              trigger.on-health-degraded: |
                - description: Application has degraded
                  send:
                  - app-health-degraded
                  when: app.status.health.status == 'Degraded'
              trigger.on-sync-failed: |
                - description: Application syncing has failed
                  send:
                  - app-sync-failed
                  when: app.status.operationState.phase in ['Error', 'Failed']
              trigger.on-sync-running: |
                - description: Application is being synced
                  send:
                  - app-sync-running
                  when: app.status.operationState.phase in ['Running']
              trigger.on-sync-status-unknown: |
                - description: Application status is 'Unknown'
                  send:
                  - app-sync-status-unknown
                  when: app.status.sync.status == 'Unknown'
              trigger.on-sync-succeeded: |
                - description: Application syncing has succeeded
                  send:
                  - app-sync-succeeded
                  when: app.status.operationState.phase in ['Succeeded']
            templates:
              template.app-deployed: |
                message: |
                  Application {{.app.metadata.name}} is now running new version.
                webhook:
                  discord:
                    method: POST
                    body: |
                      {
                        "embeds": [{
                          "title": "✅ Application Deployed",
                          "description": "Application **{{.app.metadata.name}}** is now running new version",
                          "color": 1615680,
                          "fields": [
                            {
                              "name": "Sync Status",
                              "value": "{{.app.status.sync.status}}",
                              "inline": true
                            },
                            {
                              "name": "Health",
                              "value": "{{.app.status.health.status}}",
                              "inline": true
                            },
                            {
                              "name": "Repository",
                              "value": "{{.app.spec.source.repoURL}}"
                            }
                          ],
                          "timestamp": "{{.app.status.operationState.finishedAt}}"
                        }]
                      }
              template.app-health-degraded: |
                message: |
                  Application {{.app.metadata.name}} has degraded.
                webhook:
                  discord:
                    method: POST
                    body: |
                      {
                        "embeds": [{
                          "title": "⚠️ Application Health Degraded",
                          "description": "Application **{{.app.metadata.name}}** has degraded",
                          "color": 15981568,
                          "fields": [
                            {
                              "name": "Health Status",
                              "value": "{{.app.status.health.status}}",
                              "inline": true
                            },
                            {
                              "name": "Sync Status",
                              "value": "{{.app.status.sync.status}}",
                              "inline": true
                            },
                            {
                              "name": "Repository",
                              "value": "{{.app.spec.source.repoURL}}"
                            }
                          ]
                        }]
                      }
                pushover:
                  title: "⚠️ ArgoCD: {{.app.metadata.name}} Degraded"
                  message: |
                    Application {{.app.metadata.name}} health is degraded.
                    Status: {{.app.status.health.status}}
                  priority: 1
                  sound: pushover
              template.app-sync-failed: |
                message: |
                  Application {{.app.metadata.name}} sync failed.
                webhook:
                  discord:
                    method: POST
                    body: |
                      {
                        "embeds": [{
                          "title": "❌ Application Sync Failed",
                          "description": "Application **{{.app.metadata.name}}** sync failed",
                          "color": 15277667,
                          "fields": [
                            {
                              "name": "Sync Status",
                              "value": "{{.app.status.sync.status}}",
                              "inline": true
                            },
                            {
                              "name": "Operation Phase",
                              "value": "{{.app.status.operationState.phase}}",
                              "inline": true
                            },
                            {
                              "name": "Repository",
                              "value": "{{.app.spec.source.repoURL}}"
                            }
                          ],
                          "timestamp": "{{.app.status.operationState.finishedAt}}"
                        }]
                      }
                pushover:
                  title: "❌ ArgoCD: {{.app.metadata.name}} Sync Failed"
                  message: |
                    Application {{.app.metadata.name}} sync failed.
                    Phase: {{.app.status.operationState.phase}}
                  priority: 1
                  sound: pushover
              template.app-sync-succeeded: |
                message: |
                  Application {{.app.metadata.name}} has been successfully synced.
                webhook:
                  discord:
                    method: POST
                    body: |
                      {
                        "embeds": [{
                          "title": "✅ Application Sync Succeeded",
                          "description": "Application **{{.app.metadata.name}}** has been successfully synced",
                          "color": 5763719,
                          "fields": [
                            {
                              "name": "Sync Status",
                              "value": "{{.app.status.sync.status}}",
                              "inline": true
                            },
                            {
                              "name": "Health",
                              "value": "{{.app.status.health.status}}",
                              "inline": true
                            },
                            {
                              "name": "Revision",
                              "value": "{{.app.status.sync.revision | trunc 7}}",
                              "inline": true
                            }
                          ],
                          "timestamp": "{{.app.status.operationState.finishedAt}}"
                        }]
                      }
          redis:
            enabled: true
          configs:
            cm:
              exec.enabled: "true"
              # Use both annotation and label for resource tracking (hybrid mode)
              # This allows existing resources (annotation-only) and new resources (annotation+label) to coexist
              application.resourceTrackingMethod: "annotation+label"
              # Ignore health checks for CRDs - they don't have meaningful health status
              # This prevents timeout errors when checking CRD health
              resource.customizations.health.apiextensions.k8s.io_CustomResourceDefinition: |
                hs = {}
                hs.status = "Healthy"
                return hs
              resource.customizations.health.helm.toolkit.fluxcd.io_HelmRelease: |
                hs = {}
                if obj.status ~= nil then
                  if obj.status.conditions ~= nil then
                    for i, condition in ipairs(obj.status.conditions) do
                      if condition.type == "Ready" and condition.status == "False" then
                        hs.status = "Degraded"
                        hs.message = condition.message
                        return hs
                      end
                      if condition.type == "Ready" and condition.status == "True" then
                        hs.status = "Healthy"
                        hs.message = condition.message
                        return hs
                      end
                    end
                  end
                end
                hs.status = "Progressing"
                hs.message = "Waiting for HelmRelease"
                return hs
              resource.customizations.health.gateway.networking.k8s.io_HTTPRoute: |
                hs = {}
                if obj.status ~= nil then
                  if obj.status.parents ~= nil then
                    for i, parent in ipairs(obj.status.parents) do
                      if parent.conditions ~= nil then
                        for j, condition in ipairs(parent.conditions) do
                          if condition.type == "Accepted" and condition.status == "True" then
                            hs.status = "Healthy"
                            hs.message = "HTTPRoute accepted by Gateway"
                            return hs
                          end
                          if condition.type == "Accepted" and condition.status == "False" then
                            hs.status = "Degraded"
                            hs.message = condition.message or "HTTPRoute not accepted"
                            return hs
                          end
                        end
                      end
                    end
                  end
                end
                hs.status = "Progressing"
                hs.message = "Waiting for HTTPRoute status"
                return hs
              resource.customizations.health.gateway.networking.k8s.io_GRPCRoute: |
                hs = {}
                if obj.status ~= nil then
                  if obj.status.parents ~= nil then
                    for i, parent in ipairs(obj.status.parents) do
                      if parent.conditions ~= nil then
                        for j, condition in ipairs(parent.conditions) do
                          if condition.type == "Accepted" and condition.status == "True" then
                            hs.status = "Healthy"
                            hs.message = "GRPCRoute accepted by Gateway"
                            return hs
                          end
                          if condition.type == "Accepted" and condition.status == "False" then
                            hs.status = "Degraded"
                            hs.message = condition.message or "GRPCRoute not accepted"
                            return hs
                          end
                        end
                      end
                    end
                  end
                end
                hs.status = "Progressing"
                hs.message = "Waiting for GRPCRoute status"
                return hs
              resource.customizations.health.postgresql.cnpg.io_Cluster: |
                hs = {}
                if obj.status ~= nil then
                  if obj.status.phase ~= nil then
                    if obj.status.phase == "Cluster in healthy state" then
                      hs.status = "Healthy"
                      hs.message = obj.status.phase
                      return hs
                    end
                    if obj.status.phase == "Waiting for the instances to become active" then
                      hs.status = "Progressing"
                      hs.message = obj.status.phase
                      return hs
                    end
                    if obj.status.phase == "Creating primary instance" then
                      hs.status = "Progressing"
                      hs.message = obj.status.phase
                      return hs
                    end
                    if obj.status.phase == "Upgrading cluster" then
                      hs.status = "Progressing"
                      hs.message = obj.status.phase
                      return hs
                    end
                  end
                  -- Check readyInstances vs instances
                  if obj.status.instances ~= nil and obj.status.readyInstances ~= nil then
                    if obj.status.readyInstances == obj.status.instances then
                      hs.status = "Healthy"
                      hs.message = string.format("%d/%d instances ready", obj.status.readyInstances, obj.status.instances)
                      return hs
                    else
                      hs.status = "Progressing"
                      hs.message = string.format("%d/%d instances ready", obj.status.readyInstances, obj.status.instances)
                      return hs
                    end
                  end
                end
                hs.status = "Progressing"
                hs.message = "Waiting for CNPG Cluster"
                return hs
            params:
              server.insecure: true
              controller.diff.server.side: "true"
    # Additional resources from git (HTTPRoute)
    - repoURL: https://github.com/operinko/homeops.git
      targetRevision: main
      path: kubernetes/argocd/applications/argocd/routes
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: false
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - RespectIgnoreDifferences=true
      - ServerSideApply=true
  ignoreDifferences:
    # Ignore HelmRelease status and labels changes
    - group: helm.toolkit.fluxcd.io
      kind: HelmRelease
      jsonPointers:
        - /status
        - /metadata/labels
    # Ignore ArgoCD-managed labels on all resources
    - group: "*"
      kind: "*"
      jsonPointers:
        - /metadata/labels/argocd.argoproj.io~1instance
    # Ignore ArgoCD server deployment changes (managed by Helm)
    - group: apps
      kind: Deployment
      name: argocd-server
      jsonPointers:
        - /spec/replicas
    # Ignore ArgoCD repo-server deployment changes (managed by Helm)
    - group: apps
      kind: Deployment
      name: argocd-repo-server
      jsonPointers:
        - /spec/template/spec/containers
        - /spec/template/spec/volumes

