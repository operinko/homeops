---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cloudnative-pg-barman-cloud
  namespace: argocd
spec:
  project: database
  source:
    repoURL: oci://ghcr.io/bjw-s-labs/helm
    chart: app-template
    targetRevision: 4.4.0
    helm:
      values: |
        controllers:
          barman-cloud:
            containers:
              app:
                image:
                  repository: ghcr.io/cloudnative-pg/plugin-barman-cloud
                  tag: v0.8.0@sha256:c3e423094c70c333a41a38dd781f0d9a9e539a2b9a2e4fe9e49224f65b4c84d6
                args:
                  - operator
                  - --leader-elect
                  - --server-cert=/server/tls.crt
                  - --server-key=/server/tls.key
                  - --client-cert=/client/tls.crt
                  - --server-address=:9090
                env:
                  SIDECAR_IMAGE: ghcr.io/cloudnative-pg/plugin-barman-cloud-sidecar:v0.8.0
                probes:
                  liveness:
                    enabled: true
                    custom: true
                    spec:
                      httpGet:
                        path: /healthz
                        port: &port 8081
                      initialDelaySeconds: 0
                      periodSeconds: 10
                      timeoutSeconds: 1
                      failureThreshold: 3
                  readiness:
                    enabled: true
                    custom: true
                    spec:
                      httpGet:
                        path: /readyz
                        port: *port
                      initialDelaySeconds: 0
                      periodSeconds: 10
                      timeoutSeconds: 1
                      failureThreshold: 3
                resources:
                  requests:
                    cpu: 10m
                  limits:
                    memory: 128Mi
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  capabilities: {drop: ["ALL"]}
            serviceAccount:
              name: barman-cloud
        defaultPodOptions:
          securityContext:
            runAsNonRoot: true
            runAsUser: 568
            runAsGroup: 568
        persistence:
          client:
            type: secret
            name: &clientCert barman-cloud-client-tls
          server:
            type: secret
            name: &serverCert barman-cloud-server-tls
        service:
          app:
            annotations:
              cnpg.io/pluginClientSecret: *clientCert
              cnpg.io/pluginPort: "9090"
              cnpg.io/pluginServerSecret: *serverCert
            labels:
              cnpg.io/pluginName: barman-cloud.cloudnative-pg.io
            ports:
              http:
                port: 9090
  destination:
    server: https://kubernetes.default.svc
    namespace: database
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true

