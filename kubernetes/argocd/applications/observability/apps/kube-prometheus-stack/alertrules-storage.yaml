---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: storage-rules
  namespace: observability
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: storage
    rules:
    - alert: PersistentVolumeAlmostFull
      expr: (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 10
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PersistentVolume {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} is almost full"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} has less than 10% space remaining (current: {{ $value | humanize }}%)"

    - alert: PersistentVolumeCriticallyFull
      expr: (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 5
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PersistentVolume {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} is critically full"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} has less than 5% space remaining (current: {{ $value | humanize }}%)"

    - alert: PersistentVolumeClaimPending
      expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PersistentVolumeClaim {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is pending"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} has been in Pending state for more than 15 minutes"

    - alert: PersistentVolumeClaimLost
      expr: kube_persistentvolumeclaim_status_phase{phase="Lost"} == 1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PersistentVolumeClaim {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} is lost"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} is in Lost state"

    - alert: PersistentVolumeErrors
      expr: kube_persistentvolume_status_phase{phase=~"Failed|Pending"} == 1
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PersistentVolume {{ $labels.persistentvolume }} has errors"
        description: "PV {{ $labels.persistentvolume }} is in {{ $labels.phase }} state"

    - alert: PersistentVolumeInodesAlmostFull
      expr: (kubelet_volume_stats_inodes_free / kubelet_volume_stats_inodes) * 100 < 10
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "PersistentVolume {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} is running out of inodes"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} has less than 10% inodes remaining (current: {{ $value | humanize }}%)"

    - alert: CephClusterWarning
      expr: ceph_health_status == 1
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Ceph cluster health is in WARNING state"
        description: "Ceph cluster has been in WARNING state for more than 10 minutes"

    - alert: CephClusterError
      expr: ceph_health_status == 2
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Ceph cluster health is in ERROR state"
        description: "Ceph cluster is in ERROR state - immediate attention required"

    - alert: CephOSDDown
      expr: ceph_osd_up == 0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Ceph OSD {{ $labels.ceph_daemon }} is down"
        description: "Ceph OSD {{ $labels.ceph_daemon }} has been down for more than 5 minutes"

    - alert: CephPoolNearFull
      expr: (ceph_pool_stored / ceph_pool_max_avail) * 100 > 85
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Ceph pool {{ $labels.name }} is near full"
        description: "Ceph pool {{ $labels.name }} is {{ $value | humanize }}% full"

