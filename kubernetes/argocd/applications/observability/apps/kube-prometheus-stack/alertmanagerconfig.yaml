---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/monitoring.coreos.com/alertmanagerconfig_v1alpha1.json
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager-receivers
  namespace: observability
  labels:
    release: kube-prometheus-stack
spec:
  route:
    groupBy: ['alertname','namespace']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: 'null'
    routes:
      - matchers:
          - name: alertname
            value: Watchdog
            matchType: '='
        receiver: 'null'
      # Log aggregator webhook - captures alerts for AI analysis
      - receiver: log-aggregator
        continue: true
      - receiver: pushover
        continue: true
      - receiver: discord
  receivers:
    - name: 'null'
    - name: log-aggregator
      webhookConfigs:
        - url: 'http://log-aggregator.tools.svc.cluster.local:8080/api/webhook/alertmanager'
          sendResolved: true
    - name: pushover
      pushoverConfigs:
        - token:
            name: alertmanager-pushover
            key: pushover_token
          userKey:
            name: alertmanager-pushover
            key: pushover_user
          sendResolved: true
          title: '{{ if eq .Status "resolved" }}[RESOLVED] {{ end }}{{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
          message: '{{ if eq .Status "resolved" }}This alert has cleared. {{ else }}New alert firing. {{ end }}Severity: {{ or .CommonLabels.severity "unknown" }}. {{ if .CommonAnnotations.description }}{{ .CommonAnnotations.description }}{{ else if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ else }}Alert {{ .CommonLabels.alertname }} in {{ if .CommonLabels.namespace }}{{ .CommonLabels.namespace }}{{ else }}unknown{{ end }}{{ end }}{{ if .CommonLabels.cluster }} on cluster {{ .CommonLabels.cluster }}.{{ end }}'
    - name: discord
      discordConfigs:
        - apiURL:
            name: alertmanager-discord
            key: webhook
          sendResolved: true
          title: '{{ if eq .Status "resolved" }}[RESOLVED] {{ end }}{{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
          message: '{{ if eq .Status "resolved" }}This alert has cleared. {{ else }}New alert firing. {{ end }}Severity: {{ or .CommonLabels.severity "unknown" }}. {{ if .CommonAnnotations.description }}{{ .CommonAnnotations.description }}{{ else if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ else }}Alert {{ .CommonLabels.alertname }} in {{ if .CommonLabels.namespace }}{{ .CommonLabels.namespace }}{{ else }}unknown{{ end }}{{ end }}{{ if .CommonLabels.cluster }} on cluster {{ .CommonLabels.cluster }}.{{ end }}'

