---
# SecretStore for pushing Elasticsearch credentials to Bitwarden via webhook
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: bitwarden-push
  namespace: observability
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  provider:
    webhook:
      url: "http://bitwarden-eso-provider.bitwarden-external-secrets.svc.cluster.local:8087/object/item/{{ .remoteRef.remoteKey }}"
      method: PUT
      headers:
        Content-Type: application/json
      # Body template - hardcode metadata we want to preserve
      body: |
        {
          "id": "{{ .remoteRef.remoteKey }}",
          "type": 1,
          "name": "elastic-secret",
          "folderId": "94fa1633-a293-4e43-9557-b8b6da7cfe66",
          "notes": "Pushed from Kubernetes via PushSecret. Do not modify.",
          "login": {
            "username": "{{ .username }}",
            "password": "{{ .password }}"
          }
        }
---
# PushSecret to sync auto-generated Elasticsearch credentials to Bitwarden
apiVersion: external-secrets.io/v1alpha1
kind: PushSecret
metadata:
  name: elasticsearch-credentials-push
  namespace: observability
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  refreshInterval: 5m  # Check every 5 minutes for changes
  updatePolicy: Replace  # Overwrite existing values in Bitwarden
  deletionPolicy: Delete  # Clean up when PushSecret is deleted

  # Reference to the auto-generated Elasticsearch credentials secret
  selector:
    secret:
      name: elasticsearch-master-credentials

  # SecretStore for pushing
  secretStoreRefs:
    - name: bitwarden-push
      kind: SecretStore

  # Push the entire secret to Bitwarden (all fields in one request)
  data:
    - match:
        remoteRef:
          remoteKey: "2c545bdb-0d45-49c7-b4c4-13d9326087a9"  # elastic-secret Bitwarden item ID

