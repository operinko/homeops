---
apiVersion: agent.k8s.elastic.co/v1alpha1
kind: Agent
metadata:
  name: elastic-agent-falco
  namespace: observability
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  version: 9.2.0
  image: docker.elastic.co/elastic-agent/elastic-agent:9.2.0
  policyID: 5f647dc0-d6b9-4d74-9051-f47d76fc017f
  elasticsearchRefs:
  - name: elasticsearch
  deployment:
    replicas: 1
    podTemplate:
      spec:
        serviceAccountName: elastic-agent
        automountServiceAccountToken: true
        containers:
        - name: agent
          env:
          - name: ELASTICSEARCH_PASSWORD
            valueFrom:
              secretKeyRef:
                name: elastic-agent-elasticsearch
                key: ELASTICSEARCH_PASSWORD
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
  config:
    id: falco-agent-policy
    revision: 1
    outputs:
      default:
        type: elasticsearch
        hosts:
        - "https://elasticsearch-es-http.observability.svc.cluster.local:9200"
        username: elastic
        password: "${ELASTICSEARCH_PASSWORD}"
    output_permissions:
      default:
        _elastic_agent_monitoring:
          indices:
          - names:
            - logs-elastic_agent-default
            privileges:
            - auto_configure
            - create_doc
          - names:
            - metrics-elastic_agent.elastic_agent-default
            privileges:
            - auto_configure
            - create_doc
        _elastic_agent_checks:
          cluster:
          - monitor
        falco-policy:
          indices:
          - names:
            - logs-*-*
            privileges:
            - auto_configure
            - create_doc
    agent:
      monitoring:
        enabled: true
        use_output: default
        logs: true
        metrics: true
        namespace: default
    inputs:
      # Collect Falco Alerts via TCP: Collect Falco Alerts via TCP input
      - id: falco-tcp
        type: tcp
        streams:
          # Syslog TCP input: Collect Falco alerts using syslog input over TCP
          - id: tcp-falco.alerts
            data_stream:
              dataset: falco.alerts
              type: logs
              elasticsearch:
                dynamic_dataset: true
                dynamic_namespace: true
            host: 0.0.0.0:9030
            tags:
              - preserve_original_event
              - preserve_falco_fields
            processors:
              - add_locale: null
              - copy_fields:
                  fields:
                    - from: message
                      to: event.original
              - syslog:
                  field: message
      # Collect Falco Alerts via log file: Collect Falco Alerts via log file input
      - id: falco-logfile
        type: logfile
        streams:
          # Logfile Input: Collect Falco Alerts using logfile input
          - id: logfile-falco.alerts
            data_stream:
              dataset: falco.alerts
              type: logs
              elasticsearch:
                dynamic_dataset: true
                dynamic_namespace: true
            paths:
              - /var/log/falco.log
            tags:
              - preserve_original_event
              - preserve_falco_fields
            exclude_files:
              - .gz$
            processors:
              - add_locale: null
