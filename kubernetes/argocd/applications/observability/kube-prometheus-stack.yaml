---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  project: observability
  source:
    repoURL: ghcr.io/prometheus-community/charts
    chart: kube-prometheus-stack
    targetRevision: 79.1.1
    helm:
      valuesObject:
        crds:
          enabled: true
          upgradeJob:
            enabled: true
            forceConflicts: true
        cleanPrometheusOperatorObjectNames: true
        kubeEtcd:
          service:
            selector:
              component: kube-apiserver
        kubeProxy:
          enabled: false
        prometheus:
          ingress:
            enabled: false
          prometheusSpec:
            podMonitorSelectorNilUsesHelmValues: false
            probeSelectorNilUsesHelmValues: false
            ruleSelectorNilUsesHelmValues: false
            scrapeConfigSelectorNilUsesHelmValues: false
            podAntiAffinity: ""
            affinity:
              podAntiAffinity:
                preferredDuringSchedulingIgnoredDuringExecution:
                  - weight: 100
                    podAffinityTerm:
                      labelSelector:
                        matchExpressions:
                          - key: cnpg.io/podRole
                            operator: In
                            values: ["primary"]
                      topologyKey: kubernetes.io/hostname
            serviceMonitorSelectorNilUsesHelmValues: false
            enableAdminAPI: true
            walCompression: true
            enableFeatures:
              - memory-snapshot-on-shutdown
            evaluationInterval: 1m
            retention: 14d
            retentionSize: 32GB
            resources:
              requests:
                cpu: 500m
              limits:
                memory: 4Gi
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: ceph-rbd
                  resources:
                    requests:
                      storage: 50Gi
        prometheus-node-exporter:
          fullnameOverride: node-exporter
          prometheus:
            monitor:
              enabled: true
              relabelings:
                - action: replace
                  regex: (.*)
                  replacement: $1
                  sourceLabels: ["__meta_kubernetes_pod_node_name"]
                  targetLabel: kubernetes_node
        kube-state-metrics:
          fullnameOverride: kube-state-metrics
          metricLabelsAllowlist:
            - pods=[*]
            - deployments=[*]
            - persistentvolumeclaims=[*]
          prometheus:
            monitor:
              enabled: true
              relabelings:
                - action: replace
                  regex: (.*)
                  replacement: $1
                  sourceLabels: ["__meta_kubernetes_pod_node_name"]
                  targetLabel: kubernetes_node
        grafana:
          enabled: false
          forceDeployDashboards: true
        additionalPrometheusRulesMap:
          dockerhub-rules:
            groups:
              - name: dockerhub
                rules:
                  - alert: DockerhubRateLimitRisk
                    annotations:
                      summary: Kubernetes cluster Dockerhub rate limit risk
                    expr: count(time() - container_last_seen{image=~"(docker.io).*",container!=""} < 30) > 100
                    labels:
                      severity: critical
          oom-rules:
            groups:
              - name: oom
                rules:
                  - alert: OomKilled
                    annotations:
                      summary: Container {{ $labels.container }} in pod {{ $labels.namespace }}/{{ $labels.pod }} has been OOMKilled {{ $value }} times in the last 10 minutes.
                    expr: (kube_pod_container_status_restarts_total - kube_pod_container_status_restarts_total offset 10m >= 1) and ignoring (reason) min_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[10m]) == 1
                    labels:
                      severity: critical
          zfs-rules:
            groups:
              - name: zfs
                rules:
                  - alert: ZfsUnexpectedPoolState
                    annotations:
                      summary: ZFS pool {{$labels.zpool}} on {{$labels.instance}} is in a unexpected state {{$labels.state}}
                    expr: node_zfs_zpool_state{state!="online"} > 0
                    labels:
                      severity: critical
  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true

