---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: homepage
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  sources:
    # Helm chart for application deployment
    - repoURL: https://bjw-s-labs.github.io/helm-charts
      targetRevision: 4.4.0
      chart: app-template
      helm:
        values: |
          controllers:
            homepage:
              replicas: 1
              strategy: RollingUpdate
              annotations:
                reloader.stakater.com/auto: "true"
              serviceAccount:
                name: homepage
              containers:
                app:
                  image:
                    repository: ghcr.io/gethomepage/homepage
                    tag: v1.5.0
                  env:
                    TZ: Europe/Helsinki
                    HOMEPAGE_ALLOWED_HOSTS: home.vaderrp.com
                    HOMEPAGE_AUTHENTIK_URL: https://auth.vaderrp.com
                    HOMEPAGE_AUTHENTIK_REDIRECT_URI: http://home.vaderrp.com/auth/callback
                    HOMEPAGE_AUTHENTIK_LOGOUT_URL: https://auth.vaderrp.com/application/o/homepage/end-session/?next=http://home.vaderrp.com/auth/logout
                  envFrom:
                    - secretRef:
                        name: homepage-secret
                  probes:
                    liveness:
                      enabled: true
                    readiness:
                      enabled: true
                  resources:
                    requests:
                      cpu: 15m
                      memory: 200M
                    limits:
                      memory: 2G
          service:
            app:
              controller: homepage
              ipFamilyPolicy: PreferDualStack
              ports:
                http:
                  port: 3000
          ingress:
            app:
              enabled: false
          defaultPodOptions:
            automountServiceAccountToken: true
          persistence:
            config:
              type: configMap
              name: homepage-config
              globalMounts:
                - subPath: bookmarks.yaml
                  path: /app/config/bookmarks.yaml
                - subPath: kubernetes.yaml
                  path: /app/config/kubernetes.yaml
                - subPath: services.yaml
                  path: /app/config/services.yaml
                - subPath: settings.yaml
                  path: /app/config/settings.yaml
                - subPath: widgets.yaml
                  path: /app/config/widgets.yaml
    # Additional resources from git (HTTPRoute, RBAC, external-secret, ConfigMap via kustomize)
    - repoURL: https://github.com/operinko/homeops.git
      targetRevision: main
      path: kubernetes/apps/default/homepage/app
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

