---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 30m
  chart:
    spec:
      chart: argo-cd
      version: 7.6.0
      sourceRef:
        kind: HelmRepository
        name: argo
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    global:
      domain: argocd.vaderrp.com

    server:
      # Disable ingress - we use Traefik IngressRoute instead
      ingress:
        enabled: false

      # Disable TLS certificate - Traefik handles TLS termination
      certificateSecret:
        enabled: false

      # Configure server to work behind HTTPS proxy
      config:
        # Tell ArgoCD it's behind HTTPS
        url: https://argocd.vaderrp.com

        # Disable TLS verification for internal connections
        # (Traefik handles TLS termination, backend uses HTTP)
        dex.config: |
          connectors:
          - type: oidc
            id: authentik
            name: authentik
            config:
              issuer: https://auth.vaderrp.com/application/o/argocd/
              clientID: sizSMIPV1FzETNbe25zeU9zsOuusbFXRqqQF9o0C
              clientSecret: $dex.authentik.clientSecret
              insecureEnableGroups: true
              scopes:
                - openid
                - profile
                - email

      # Service configuration
      service:
        type: ClusterIP
        port: 80

      # Disable HTTPS on the service itself
      # (Traefik handles TLS termination)
      extraArgs:
        - --insecure

    controller:
      # Standard controller config
      replicas: 1

    applicationSet:
      enabled: true
      replicas: 1

    notifications:
      enabled: false

    redis:
      enabled: true

    configs:
      cm:
        exec.enabled: "true"
        # KSOPS plugin for SOPS decryption
        kustomize.buildOptions: "--enable-alpha-plugins"
      params:
        controller.diff.server.side: "true"
      cmp:
        create: true
        plugins:
          ksops:
            image: viaductai/ksops:v4.2.3
            name: ksops
            args: kustomize
            env:
              - name: SOPS_AGE_KEY_FILE
                value: /home/argocd/.config/sops/age/keys.txt
              - name: KUSTOMIZE_PLUGIN_PATH
                value: /home/argocd/.config/kustomize/plugin

    repoServer:
      # Enable SOPS support for decrypting secrets
      volumes:
        - name: sops-age
          secret:
            secretName: sops-age
            items:
              - key: age.agekey
                path: keys.txt
      volumeMounts:
        - name: sops-age
          mountPath: /home/argocd/.config/sops/age
          readOnly: true
      env:
        - name: SOPS_AGE_KEY_FILE
          value: /home/argocd/.config/sops/age/keys.txt

    # Gateway API HTTPRoute configuration
    httproute:
      enabled: true
      labels:
        route.scope: internal
      annotations:
        external-dns.alpha.kubernetes.io/public: "false"
      parentRefs:
        - name: gateway-internal
          namespace: gateway
          sectionName: https
      hostnames:
        - argocd.vaderrp.com
      rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          backendRefs:
            - name: argocd-server
              port: 80

    # Gateway API GRPCRoute configuration
    grpcroute:
      enabled: true
      labels:
        route.scope: internal
      annotations:
        external-dns.alpha.kubernetes.io/public: "false"
      parentRefs:
        - name: gateway-internal
          namespace: gateway
          sectionName: https
      hostnames:
        - argocd.vaderrp.com
      rules:
        - matches:
            - headers:
                - name: content-type
                  value: application/grpc
          backendRefs:
            - name: argocd-server
              port: 80

