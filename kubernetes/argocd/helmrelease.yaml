---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 30m
  chart:
    spec:
      chart: argo-cd
      version: 7.6.0
      sourceRef:
        kind: HelmRepository
        name: argo
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    global:
      domain: argocd.vaderrp.com

    server:
      # Disable ingress - we use Traefik IngressRoute instead
      ingress:
        enabled: false

      # Disable TLS certificate - Traefik handles TLS termination
      certificateSecret:
        enabled: false

      # Configure server to work behind HTTPS proxy
      config:
        # Tell ArgoCD it's behind HTTPS
        url: https://argocd.vaderrp.com

        # Disable TLS verification for internal connections
        # (Traefik handles TLS termination, backend uses HTTP)
        dex.config: |
          connectors:
          - type: oidc
            id: authentik
            name: authentik
            config:
              issuer: https://auth.vaderrp.com/application/o/argocd/
              clientID: sizSMIPV1FzETNbe25zeU9zsOuusbFXRqqQF9o0C
              clientSecret: $dex.authentik.clientSecret
              insecureEnableGroups: true
              scopes:
                - openid
                - profile
                - email

      # Service configuration
      service:
        type: ClusterIP
        port: 80

      # Disable HTTPS on the service itself
      # (Traefik handles TLS termination)
      extraArgs:
        - --insecure

    controller:
      # Standard controller config
      replicas: 1

    applicationSet:
      enabled: true
      replicas: 1

    notifications:
      enabled: false

    redis:
      enabled: true

    configs:
      cm:
        exec.enabled: "true"
      params:
        controller.diff.server.side: "true"
      cmp:
        create: true
        plugins:
          sops:
            init:
              command: [sh]
              args: [-c, "echo 'SOPS plugin initialized'"]
            generate:
              command: [sh, -c]
              args:
                - |
                  # Decrypt SOPS files and pass through kustomize
                  find . -name '*.sops.yaml' -o -name '*.sops.yml' | while read f; do
                    sops -d "$f" > "${f%.sops*}.yaml"
                  done
                  kustomize build .
            discover:
              fileName: kustomization.yaml

    repoServer:
      # Enable SOPS support for decrypting secrets
      volumes:
        - name: sops-age
          secret:
            secretName: sops-age
            items:
              - key: age.agekey
                path: keys.txt
        - name: cmp-tmp
          emptyDir: {}
      volumeMounts:
        - name: sops-age
          mountPath: /home/argocd/.config/sops/age
          readOnly: true
      env:
        - name: SOPS_AGE_KEY_FILE
          value: /home/argocd/.config/sops/age/keys.txt

      # CMP sidecar for SOPS decryption
      initContainers:
        - name: install-sops
          image: quay.io/argoproj/argocd:v2.12.3
          command: [sh, -c]
          args:
            - |
              # Install sops if not already present
              if ! command -v sops &> /dev/null; then
                apk add --no-cache sops
              fi
          volumeMounts:
            - name: cmp-tmp
              mountPath: /tmp

      extraContainers:
        - name: sops-cmp
          image: quay.io/argoproj/argocd:v2.12.3
          command: [/var/run/argocd/argocd-cmp-server]
          securityContext:
            runAsNonRoot: true
            readOnlyRootFilesystem: true
          volumeMounts:
            - name: var-files
              mountPath: /var/run/argocd
            - name: plugins
              mountPath: /home/argocd/cmp-server/plugins
            - name: tmp
              mountPath: /tmp
            - name: sops-age
              mountPath: /home/argocd/.config/sops/age
              readOnly: true
          env:
            - name: SOPS_AGE_KEY_FILE
              value: /home/argocd/.config/sops/age/keys.txt

    # Gateway API HTTPRoute configuration
    httproute:
      enabled: true
      labels:
        route.scope: internal
      annotations:
        external-dns.alpha.kubernetes.io/public: "false"
      parentRefs:
        - name: gateway-internal
          namespace: gateway
          sectionName: https
      hostnames:
        - argocd.vaderrp.com
      rules:
        - matches:
            - path:
                type: PathPrefix
                value: /
          backendRefs:
            - name: argocd-server
              port: 80

    # Gateway API GRPCRoute configuration
    grpcroute:
      enabled: true
      labels:
        route.scope: internal
      annotations:
        external-dns.alpha.kubernetes.io/public: "false"
      parentRefs:
        - name: gateway-internal
          namespace: gateway
          sectionName: https
      hostnames:
        - argocd.vaderrp.com
      rules:
        - matches:
            - headers:
                - name: content-type
                  value: application/grpc
          backendRefs:
            - name: argocd-server
              port: 80

