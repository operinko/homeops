---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: argocd
  namespace: argocd
spec:
  interval: 30m
  chart:
    spec:
      chart: argo-cd
      version: 7.6.0
      sourceRef:
        kind: HelmRepository
        name: argo
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    global:
      domain: argocd.vaderrp.com

    server:
      # Disable ingress - we use Traefik IngressRoute instead
      ingress:
        enabled: false

      # Disable TLS certificate - Traefik handles TLS termination
      certificateSecret:
        enabled: false

      # Configure server to work behind HTTPS proxy
      config:
        # Tell ArgoCD it's behind HTTPS
        url: https://argocd.vaderrp.com

        # Disable TLS verification for internal connections
        # (Traefik handles TLS termination, backend uses HTTP)
        dex.config: |
          connectors:
          - type: oidc
            id: authentik
            name: Authentik
            config:
              issuer: https://auth.vaderrp.com/application/o/argocd/
              clientID: argocd
              clientSecret: $dex.authentik.clientSecret
              scopes:
                - openid
                - profile
                - email
              userIDKey: sub
              userNameKey: preferred_username

      # Service configuration
      service:
        type: ClusterIP
        port: 80

      # Disable HTTPS on the service itself
      # (Traefik handles TLS termination)
      extraArgs:
        - --insecure

    controller:
      # Standard controller config
      replicas: 1

    applicationSet:
      enabled: true
      replicas: 1

    notifications:
      enabled: false

    redis:
      enabled: true

