---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: ${APP}-volsync-secret
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vaultwarden
    kind: ClusterSecretStore
  target:
    name: ${APP}-volsync-secret
    template:
      engineVersion: v2
      data:
        RESTIC_REPOSITORY: "{{ .restic_repository }}${APP}"
        RESTIC_PASSWORD: "{{ .restic_password }}"
        AWS_ACCESS_KEY_ID: "{{ .aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ .aws_secret_access_key }}"
        AWS_DEFAULT_REGION: "{{ .aws_default_region }}"
        AWS_REGION: "{{ .aws_region }}"
        AWS_S3_FORCE_PATH_STYLE: "{{ .aws_s3_force_path_style }}"
        AWS_ENDPOINT: "{{ .aws_endpoint }}"
  data:
    - secretKey: restic_repository
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: restic_repository
    - secretKey: restic_password
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: restic_password
    - secretKey: aws_access_key_id
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: aws_access_key_id
    - secretKey: aws_secret_access_key
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: aws_secret_access_key
    - secretKey: aws_default_region
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: aws_default_region
    - secretKey: aws_region
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: aws_region
    - secretKey: aws_s3_force_path_style
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: aws_s3_force_path_style
    - secretKey: aws_endpoint
      remoteRef:
        key: ${VOLSYNC_SECRET_ID}
        property: aws_endpoint

