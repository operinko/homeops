---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - external-secret.yaml
  - replicationsource.yaml
  - replicationdestination.yaml
  - pvc.yaml

replacements:
  # Replace APP name in all resources
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.APP
    targets:
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - metadata.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - metadata.name
          - spec.sourcePVC
          - spec.restic.repository
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - metadata.name
          - spec.restic.repository
      - select:
          kind: ExternalSecret
        fieldPaths:
          - metadata.name
          - spec.target.name

  # Replace capacity
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_CAPACITY
    targets:
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - spec.resources.requests.storage
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.capacity

  # Replace UID
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_UID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser

  # Replace GID
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_GID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup

