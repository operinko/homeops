---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - external-secret.yaml
  - replicationsource.yaml
  - replicationdestination.yaml
  - pvc.yaml

configurations:
  - nameReference.yaml

patches:
  # Add templateFrom to ExternalSecret to pull RESTIC_REPOSITORY_TEMPLATE from app's ConfigMap
  # Note: The configMap name will be automatically updated by kustomize's nameReference
  - target:
      kind: ExternalSecret
      name: secret-placeholder
    patch: |-
      - op: add
        path: /spec/target/template/templateFrom
        value:
          - configMap:
              name: volsync-config
              items:
                - key: RESTIC_REPOSITORY_TEMPLATE
                  templateAs: KeysAndValues

replacements:
  # Replace PVC name
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_PVC
    targets:
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - metadata.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.sourcePVC

  # Replace ReplicationSource name
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_REPL_SOURCE
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - metadata.name

  # Replace ReplicationDestination name
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_REPL_DEST
    targets:
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - metadata.name
      - select:
          kind: PersistentVolumeClaim
          name: pvc-placeholder
        fieldPaths:
          - spec.dataSourceRef.name

  # Replace ExternalSecret name
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_SECRET
    targets:
      - select:
          kind: ExternalSecret
          name: secret-placeholder
        fieldPaths:
          - metadata.name
          - spec.target.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.repository
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.repository

  # Replace capacity
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_CAPACITY
    targets:
      - select:
          kind: PersistentVolumeClaim
          name: pvc-placeholder
        fieldPaths:
          - spec.resources.requests.storage
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.capacity

  # Replace UID
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_UID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser

  # Replace GID
  - source:
      kind: ConfigMap
      name: .*-volsync-config
      fieldPath: data.VOLSYNC_GID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup
