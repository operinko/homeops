---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - external-secret.yaml
  - replicationsource.yaml
  - replicationdestination.yaml
  - pvc.yaml

configurations:
  - nameReference.yaml

replacements:
  # Replace ConfigMap name in ExternalSecret templateFrom
  # Use the VOLSYNC_CONFIGMAP field which contains the full ConfigMap name
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_CONFIGMAP
    targets:
      - select:
          kind: ExternalSecret
          name: secret-placeholder
        fieldPaths:
          - spec.target.template.templateFrom.0.configMap.name

  # Replace PVC name
  # Kustomize will select the ConfigMap that has the VOLSYNC_PVC field
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_PVC
    targets:
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - metadata.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.sourcePVC

  # Replace ReplicationSource name
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_REPL_SOURCE
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - metadata.name

  # Replace ReplicationDestination name
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_REPL_DEST
    targets:
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - metadata.name
      - select:
          kind: PersistentVolumeClaim
          name: pvc-placeholder
        fieldPaths:
          - spec.dataSourceRef.name

  # Replace ExternalSecret name
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_SECRET
    targets:
      - select:
          kind: ExternalSecret
          name: secret-placeholder
        fieldPaths:
          - metadata.name
          - spec.target.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.repository
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.repository

  # Replace capacity
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_CAPACITY
    targets:
      - select:
          kind: PersistentVolumeClaim
          name: pvc-placeholder
        fieldPaths:
          - spec.resources.requests.storage
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.capacity

  # Replace UID
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_UID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser

  # Replace GID
  - source:
      kind: ConfigMap
      fieldPath: data.VOLSYNC_GID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup
