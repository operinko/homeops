---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

resources:
  - external-secret.yaml
  - replicationsource.yaml
  - replicationdestination.yaml
  - pvc.yaml

configurations:
  - nameReference.yaml

patches:
  - target:
      kind: ExternalSecret
      name: secret-placeholder
    patch: |-
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: not-important
      spec:
        target:
          template:
            templateFrom:
              - configMap:
                  name: volsync-config
                  items:
                    - key: RESTIC_REPOSITORY_TEMPLATE
                      templateAs: KeysAndValues

replacements:
  # Replace PVC name
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_PVC
    targets:
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - metadata.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.sourcePVC

  # Replace ReplicationSource name
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_REPL_SOURCE
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - metadata.name

  # Replace ReplicationDestination name
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_REPL_DEST
    targets:
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - metadata.name
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - spec.dataSourceRef.name

  # Replace ExternalSecret name
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_SECRET
    targets:
      - select:
          kind: ExternalSecret
          name: secret-placeholder
        fieldPaths:
          - metadata.name
          - spec.target.name
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.repository
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.repository

  # Replace capacity
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_CAPACITY
    targets:
      - select:
          kind: PersistentVolumeClaim
        fieldPaths:
          - spec.resources.requests.storage
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.capacity

  # Replace UID
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_UID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsUser

  # Replace GID
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.VOLSYNC_GID
    targets:
      - select:
          kind: ReplicationSource
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup
      - select:
          kind: ReplicationDestination
        fieldPaths:
          - spec.restic.moverSecurityContext.runAsGroup
          - spec.restic.moverSecurityContext.fsGroup

  # Rename ConfigMap to be app-specific: "volsync-config" -> "{app}-volsync-config"
  - source:
      kind: ConfigMap
      name: volsync-config
      fieldPath: data.APP
    targets:
      - select:
          kind: ConfigMap
          name: volsync-config
        fieldPaths:
          - metadata.name
        options:
          delimiter: "volsync"
          index: 0
      - select:
          kind: ExternalSecret
          name: secret-placeholder
        fieldPaths:
          - spec.target.template.templateFrom.0.configMap.name
        options:
          delimiter: "volsync"
          index: 0
