---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: crowdsec-bouncer
spec:
  plugin:
    bouncer:
      enabled: true
      logLevel: DEBUG
      crowdsecMode: stream
      # CrowdSec LAPI URL
      crowdsecLapiHost: crowdsec-service.network.svc.cluster.local:8080
      crowdsecLapiScheme: http
      # Read the API key from mounted secret file
      crowdsecLapiKeyFile: /var/run/secrets/crowdsec/lapi_key
      crowdsecLapiTLSInsecureVerify: true
      crowdsecLapiPath: "/"
      crowdsecAppsecEnabled: true
      crowdsecAppsecHost: crowdsec-appsec-service.network.svc.cluster.local:7422
      crowdsecAppsecPath: "/"
      crowdsecAppsecFailureBlock: true
      crowdsecAppsecUnreachableBlock: true
      crowdsecAppsecBodyLimit: 10485760
      # Trust the real client IP from Cloudflare tunnel (CF-Connecting-IP)
      forwardedHeadersCustomName: CF-Connecting-IP
      # Trust in-cluster pod CIDR for tunnel egress; adjust if yours differs
      forwardedHeadersTrustedIPs:
        - 10.42.0.0/16
        - 192.168.7.5/32
        - 192.168.7.4/32
      # Bypass LAN and in-cluster clients
      clientTrustedIPs:
        - 192.168.0.0/16
        - 10.42.0.0/16
      # Captcha disabled: block-only mode
      # Performance
      updateIntervalSeconds: 60
      httpTimeoutSeconds: 10

