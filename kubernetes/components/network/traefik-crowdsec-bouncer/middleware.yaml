---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: crowdsec-bouncer
spec:
  plugin:
    bouncer:
      enabled: true
      logLevel: INFO
      crowdsecMode: stream
      # CrowdSec LAPI URL
      crowdsecLapiHost: crowdsec-service.network.svc.cluster.local:8080
      crowdsecLapiScheme: http
      # Read the API key from mounted secret file
      crowdsecLapiKeyFile: /var/run/secrets/crowdsec/lapi_key
      crowdsecLapiTLSInsecureVerify: true
      crowdsecLapiPath: "/"
      crowdsecAppsecEnabled: false
      # Trust the real client IP from Cloudflare tunnel (CF-Connecting-IP)
      forwardedHeadersCustomName: CF-Connecting-IP
      # Trust in-cluster pod CIDR for tunnel egress; adjust if yours differs
      forwardedHeadersTrustedIPs:
        - 10.42.0.0/16
        - 192.168.7.5/32
        - 192.168.7.4/32
      # Bypass LAN, in-cluster clients, and GitHub webhook IPs
      clientTrustedIPs:
        - 192.168.0.0/16
        - 10.42.0.0/16
        # GitHub webhook IPs (https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/about-githubs-ip-addresses)
        - 192.30.252.0/22
        - 185.199.108.0/22
        - 140.82.112.0/20
        - 143.55.64.0/20
        - 2a0a:a440::/29
        - 2606:50c0::/32
      # Captcha disabled: block-only mode
      # Performance tuning
      updateIntervalSeconds: 120 # Increased from 60 to reduce LAPI overhead
      httpTimeoutSeconds: 30 # Increased from 10 to prevent timeout on initial stream connection
      updateMaxFailure: 5 # Allow more failures before marking as down

