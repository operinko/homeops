---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: crowdsec-bouncer
spec:
  plugin:
    bouncer:
      enabled: true
      crowdsecMode: stream
      # CrowdSec LAPI URL
      crowdsecLapiHost: crowdsec-lapi.network.svc.cluster.local:8080
      crowdsecLapiScheme: http
      # Read the API key from mounted secret file
      CrowdsecLapiKeyFile: /var/run/secrets/crowdsec/lapi_key
      # Trust the real client IP from Cloudflare tunnel (CF-Connecting-IP)
      forwardedHeadersCustomName: CF-Connecting-IP
      # Trust in-cluster pod CIDR for tunnel egress; adjust if yours differs
      forwardedHeadersTrustedIPs:
        - 10.42.0.0/16
      # Bypass LAN and in-cluster clients
      clientTrustedIPs:
        - 192.168.0.0/16
        - 10.42.0.0/16
      # Captcha remediation (Cloudflare Turnstile)
      captchaProvider: turnstile
      CaptchaSiteKeyFile: /var/run/secrets/crowdsec/captcha_site_key
      CaptchaSecretKeyFile: /var/run/secrets/crowdsec/captcha_secret_key
      # Performance and UX
      updateIntervalSeconds: 60
      httpTimeoutSeconds: 10

