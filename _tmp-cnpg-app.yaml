apiVersion: v1
kind: Secret
metadata:
  name: cloudnative-pg-secret
  namespace: database
sops:
  age:
  - enc: |
      -----BEGIN AGE ENCRYPTED FILE-----
      YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBOZVBtV2ROR1RVbVg4WUVm
      Z05WTjkrTWUzZFlRUVFjNEtHUVJ3TTBMdmg0CkdmUS9MUWFPTjc3dWtoL2kwa3gw
      cTg4MHhIeW5rOG5lRWE3QnkwM25DR28KLS0tIC9VL0l6dHpQZjlBZ0NtMmlWSGc1
      UmFOT1h5T3RlbklPT2N5ckNETkFLVUUKNSz2ur+OAlH+25E0tBmHq9MD0S2aVOor
      5d67Msex+7/B6ZKouRi1qTjit7WCmUEWbIyMK6flCz7fv67iwMFv1A==
      -----END AGE ENCRYPTED FILE-----
    recipient: age1da5dxk5g0l9l72gksgwu58wgc4jr6dstvfdglcea9edy53wxuetsl6dy7u
  azure_kv: []
  encrypted_regex: ^(data|stringData)$
  gcp_kms: []
  hc_vault: []
  kms: []
  lastmodified: "2025-06-02T09:54:23Z"
  mac: ENC[AES256_GCM,data:RkIHy8zQqLoyeAWu7W8R/xj4sNSXwh8KkwcwfY2hzo1YokIr4AB6QK5A238NEdJD+WwiH3Akhta4h/EecOQAj1EBTBDUgf8NhamxIoYBuNjxmJkopb69jVHGyefyEf3eLG3pr+AlgGb3Hu14FLV/JjqrKD1fyzHQMNCG84MbTds=,iv:JCiijchzkhiymKwdligaB8ClMRzRKTQBGGiFm25+j88=,tag:ZzwkQmI1JqQjV9oiQMQLsg==,type:str]
  mac_only_encrypted: true
  pgp: []
  version: 3.9.4
stringData:
  aws-access-key-id: ENC[AES256_GCM,data:yqBNP1U5CWA5o0A=,iv:0hHO6mVbmVZqncsLW0HFubsfSID7DD9Rwxw4j2fkyy8=,tag:Z8qdHRqSXtd7FzhUlSr+Bw==,type:str]
  aws-secret-access-key: ENC[AES256_GCM,data:+nZqOEuOazdgKOfPJjMWjR/DiwTwTu4hj4gBvOkxg+G5aEspQcaJ4w==,iv:68ukmfthPycGnpzvzjsb3OsoWfOkrcgZQZ9EJiJ9UWw=,tag:bURI2EyMfSJut6SyFTwo+g==,type:str]
  password: ENC[AES256_GCM,data:3PfziGYJvevXWR3lFtYyS3NfjIxBS7+1bAdAYJDDc3k=,iv:vKgpCFJ4C5mKTHYGwAE0lvYY9DlFvwlVEARU4S0obv0=,tag:OZRAJI/KG5Ve9/NFwEdaRg==,type:str]
  username: ENC[AES256_GCM,data:hWxRsF0s/5s=,iv:kub6DZo2G+Q8gPgHldxbcb788Len9xa23l0Vc+HrK2s=,tag:wtxjhLqoV0rOpNc1EjPiMA==,type:str]
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cloudnative-pg
  namespace: database
spec:
  chart:
    spec:
      chart: cloudnative-pg
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: cloudnative-pg
        namespace: flux-system
      version: 0.26.0
  install:
    remediation:
      retries: -1
  interval: 15m
  maxHistory: 2
  uninstall:
    keepHistory: false
  upgrade:
    cleanupOnFail: false
    remediation:
      retries: 3
  values:
    crds:
      create: true
    monitoring:
      grafanaDashboard:
        create: true
      podMonitorEnabled: true
    replicaCount: 2
    service:
      annotations:
        lbipam.cilium.io/ips: 192.168.7.22
      type: LoadBalancer
---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: plugin-barman-cloud
  namespace: database
spec:
  healthChecks:
  - apiVersion: apps/v1
    kind: Deployment
    name: barman-cloud
    namespace: database
  images:
  - name: ghcr.io/cloudnative-pg/plugin-barman-cloud-testing
    newName: ghcr.io/cloudnative-pg/plugin-barman-cloud
    newTag: v0.6.0
  interval: 15m
  patches:
  - patch: |-
      stringData:
        SIDECAR_IMAGE: ghcr.io/cloudnative-pg/plugin-barman-cloud-sidecar:v0.6.0
    target:
      kind: Secret
      labelSelector: kustomize.toolkit.fluxcd.io/name=plugin-barman-cloud
  path: .
  prune: true
  sourceRef:
    kind: GitRepository
    name: plugin-barman-cloud
  targetNamespace: database
  timeout: 5m
  wait: true
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: GitRepository
metadata:
  name: plugin-barman-cloud
  namespace: database
spec:
  ignore: |
    # ignore all
    /*
    # except the manifest
    !/manifest.yaml
  interval: 30m
  ref:
    tag: v0.6.0
  url: https://github.com/cloudnative-pg/plugin-barman-cloud

