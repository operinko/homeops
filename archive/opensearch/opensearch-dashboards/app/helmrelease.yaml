---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app opensearch-dashboards
  namespace: &namespace security
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  maxHistory: 3
  uninstall:
    keepHistory: false
  values:
    persistence:
      dashboards:
        type: configMap
        name: opensearch-dashboards-dashboards
        globalMounts:
          - path: /usr/share/opensearch-dashboards/import
    controllers:
      main:
        replicas: 1
        containers:
          app:
            image:
              repository: opensearchproject/opensearch-dashboards
              tag: 3.2.0
            env:
              OPENSEARCH_HOSTS: '["http://192.168.0.221:9200"]'
              SERVER_PUBLICBASEURL: https://security.vaderrp.com
              SERVER_HOST: 0.0.0.0
              DISABLE_SECURITY_DASHBOARDS_PLUGIN: "true"
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 1Gi
          importer:
            image:
              repository: curlimages/curl
              tag: 8.16.0
              pullPolicy: IfNotPresent
            env:
              OSD_URL: http://127.0.0.1:5601
            command:
              - sh
              - -c
              - |
                set -eu
                echo "Waiting for OpenSearch Dashboards at ${OSD_URL}..."
                for i in $(seq 1 120); do
                  if curl -sSf "${OSD_URL}/api/status" >/dev/null; then
                    echo "Dashboards is up"; break
                  fi
                  sleep 2
                done
                echo "Creating Data Views (if missing)"
                curl -sS -X POST "${OSD_URL}/api/data_views/data_view" -H "osd-xsrf: true" -H "Content-Type: application/json" \
                  -d '{"data_view": {"title": "logs-unifi-*", "name": "logs-unifi", "timeFieldName": "@timestamp"}}' || true
                curl -sS -X POST "${OSD_URL}/api/data_views/data_view" -H "osd-xsrf: true" -H "Content-Type: application/json" \
                  -d '{"data_view": {"title": "logs-k8s-v2-*", "name": "logs-k8s-v2", "timeFieldName": "@timestamp"}}' || true
                for f in /usr/share/opensearch-dashboards/import/*.ndjson; do
                  echo "Importing $f"
                  curl -sS -X POST "${OSD_URL}/api/saved_objects/_import?overwrite=true" -H "osd-xsrf: true" -F file=@"$f" || true
                done
                echo "Imports complete; sleeping"
                sleep infinity
            resources:
              requests:
                cpu: 5m
                memory: 16Mi
              limits:
                memory: 64Mi
    defaultPodOptions:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile: { type: RuntimeDefault }
    service:
      app:
        controller: main
        ports:
          http:
            port: 5601
    ingress:
      app:
        enabled: false
        className: external

