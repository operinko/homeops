{
  "name": "Kubernetes Log Summarizer",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 22
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1728,
        576
      ],
      "id": "52d9a2b3-c1fb-4992-94f7-4873669aee4e",
      "name": "Daily 22:00"
    },
    {
      "parameters": {
        "jsCode": "const ollamaResponse = $input.first().json;\n\nlet analysis = ollamaResponse.output || '';\ntry {\n  // Normalize arrays\n  const normalizeArray = (arr) => {\n    if (!Array.isArray(arr)) return [];\n    return arr.map(item => {\n      if (typeof item === 'string') return item;\n      if (typeof item === 'object') {\n        const values = Object.values(item);\n        if (values.length > 0) {\n          const first = values[0];\n          if (typeof first === 'string') return first;\n          if (typeof first === 'object' && first.description) return first.description;\n          return JSON.stringify(first);\n        }\n      }\n      return String(item);\n    });\n  };\n  \n  analysis.critical_issues = normalizeArray(analysis.critical_issues);\n  analysis.warnings = normalizeArray(analysis.warnings);\n  analysis.recommendations = normalizeArray(analysis.recommendations);\n  analysis.patterns = normalizeArray(analysis.patterns);\n  \n} catch (e) {\n  analysis = {\n    overall_health: 'unknown',\n    total_alerts: 0,\n    critical_issues: ['Failed to parse AI response: ' + e.message],\n    warnings: [],\n    patterns: [],\n    recommendations: ['Check Ollama connectivity'],\n    summary: 'Analysis failed'\n  };\n}\n\nconst healthEmoji = {\n  'healthy': '‚úÖ',\n  'warning': '‚ö†Ô∏è',\n  'critical': 'üî¥',\n  'unknown': '‚ùì'\n}[analysis.overall_health.toString()] || '‚ùì';\n\nconst today = new Date().toISOString().split('T')[0];\n\n// Build Discord embed\nconst discordEmbed = {\n  embeds: [{\n    title: `${healthEmoji} Kubernetes Daily Summary`,\n    color: analysis.overall_health === 'critical' ? 0xff0000 :\n           analysis.overall_health === 'warning' ? 0xffaa00 : 0x00ff00,\n    fields: [\n      {\n        name: 'üìä Overview',\n        value: `**Alerts:** ${analysis.total_alerts || 0}\\n**Period:** ${today}`,\n        inline: true\n      },\n      {\n        name: 'üè• Health',\n        value: analysis.overall_health.toUpperCase(),\n        inline: true\n      }\n    ],\n    description: analysis.summary,\n    timestamp: new Date().toISOString()\n  }]\n};\n\nif (analysis.critical_issues?.length > 0) {\n  discordEmbed.embeds[0].fields.push({\n    name: 'üî¥ Critical Issues',\n    value: analysis.critical_issues.slice(0, 5).map(i => `‚Ä¢ ${i}`).join('\\n'),\n    inline: false\n  });\n}\n\nif (analysis.warnings?.length > 0) {\n  discordEmbed.embeds[0].fields.push({\n    name: '‚ö†Ô∏è Warnings',\n    value: analysis.warnings.slice(0, 5).map(w => `‚Ä¢ ${w}`).join('\\n'),\n    inline: false\n  });\n}\n\nif (analysis.recommendations?.length > 0) {\n  discordEmbed.embeds[0].fields.push({\n    name: 'üí° Recommendations',\n    value: analysis.recommendations.slice(0, 5).map(r => `‚Ä¢ ${r}`).join('\\n'),\n    inline: false\n  });\n}\n\n// Build HTML email\nconst html = `\n<h2>${healthEmoji} Kubernetes Daily Summary - ${today}</h2>\n<p><strong>Overall Health:</strong> ${analysis.overall_health.toUpperCase()}</p>\n<p><strong>Total Alerts:</strong> ${analysis.total_alerts || 0}</p>\n\n<h3>üìù Summary</h3>\n<p>${analysis.summary}</p>\n\n<h3>üî¥ Critical Issues</h3>\n<ul>\n${analysis.critical_issues?.map(i => `<li>${i}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<h3>‚ö†Ô∏è Warnings</h3>\n<ul>\n${analysis.warnings?.map(w => `<li>${w}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<h3>üîç Patterns Detected</h3>\n<ul>\n${analysis.patterns?.map(p => `<li>${p}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<h3>üí° Recommendations</h3>\n<ul>\n${analysis.recommendations?.map(r => `<li>${r}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<hr>\n<p><em>Generated by Kubernetes Log Summarizer</em></p>\n`;\n\nreturn {\n  json: {\n    analysis,\n    discordEmbed,\n    emailSubject: `${healthEmoji} K8s Summary: ${analysis.overall_health.toUpperCase()} - ${today}`,\n    emailHtml: html,\n    isCritical: analysis.overall_health === 'critical',\n    hasAlerts: (analysis.total_alerts || 0) > 0\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1136,
        576
      ],
      "id": "31f7d9fa-2b32-46d5-90e9-6059f39ac6ed",
      "name": "Format Output"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "[discord-webhook]",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.discordEmbed) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -656,
        464
      ],
      "id": "07a3263d-fef1-4993-9475-536f13e27dfe",
      "name": "Discord Notification"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-critical",
              "leftValue": "={{ $json.isCritical }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -656,
        672
      ],
      "id": "db73a741-abbd-4ec5-b7b6-a366b27505c6",
      "name": "Is Critical?"
    },
    {
      "parameters": {
        "fromEmail": "=[from-email]",
        "toEmail": "=[to-email]",
        "subject": "={{ $json.emailSubject }}",
        "html": "={{ $json.emailHtml }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -448,
        672
      ],
      "id": "ea9d0b69-86e5-432e-acd6-d7319df87794",
      "name": "Email (Critical Only)",
      "webhookId": "d79f87df-bb07-4b9f-88ef-7ba543b107cb",
      "credentials": {
        "smtp": {
          "id": "8W2f913lRgITIuAU",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://log-aggregator.tools.svc.cluster.local:8080/api/complete",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -448,
        464
      ],
      "id": "c720f48f-2be9-4b02-9d6e-3a14ce5e7014",
      "name": "Mark Complete"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-alerts",
              "leftValue": "={{ $json.hasAlerts }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -864,
        576
      ],
      "id": "66869dce-e223-4c0c-a1e5-3c27c7428f49",
      "name": "Has Alerts?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "[discord-webhook]",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"embeds\": [{\n    \"title\": \"‚úÖ Kubernetes Daily Summary\",\n    \"color\": 65280,\n    \"description\": \"No alerts recorded in the last 24 hours. All systems healthy.\",\n    \"timestamp\": \"{{ new Date().toISOString() }}\"\n  }]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -656,
        800
      ],
      "id": "0af1219e-6d22-454d-99e3-d62c81562486",
      "name": "Discord (No Alerts)"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Analyze the Kubernetes cluster health for today. Use the available tools to gather data.",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a Kubernetes cluster health analyst with access to MCP tools for querying cluster data.\n\nAVAILABLE TOOLS:\n- get_cluster_health(): Get overall cluster health summary with top alert types and affected services\n- list_alerts(hours_back, severity, limit): Get lightweight alert list (id, alert, severity, service, namespace). Use severity='critical' or 'warning' to filter.\n- get_alert_details(alert_id): Get full details for one alert (pod, container, timestamps, summary) - use the id from list_alerts\n- get_pod_logs(namespace, pod): Fetch recent logs for a specific pod\n- get_pod_events(namespace, pod): Fetch Kubernetes events for a namespace/pod\n- get_pod_metrics(namespace, pod): Get current CPU/memory usage for a pod\n\nWORKFLOW:\n1. Call get_cluster_health() to get an overview\n2. Call list_alerts(severity='critical') then list_alerts(severity='warning', limit=15)\n3. For top alerts, call get_alert_details(alert_id) to get pod names and summaries\n4. For critical issues, investigate with get_pod_logs/get_pod_events/get_pod_metrics\n5. Synthesize findings into the required JSON output\n\nRULES:\n- Your FINAL response MUST be a valid JSON object\n- Do NOT include any text before or after the JSON\n- Do NOT use markdown code blocks\n- ALWAYS name the affected services - never just say \"PodCrashLooping (28 times)\"\n- Format: \"service (namespace): alert type - brief description\"\n- If multiple services have the same issue, list the top 5 most important ones\n- Look for PATTERNS: Multiple alerts from same namespace, recurring issue types\n\nANTI-HALLUCINATION RULES:\n- ONLY report services that appear in the MCP tool responses\n- Do NOT invent services - if you don't see it in the data, do NOT report it\n- Extract service names from pod names (e.g., pod 'sonarr-abc123-xyz' ‚Üí service 'sonarr')\n- Extract namespaces from the alert data, never guess\n- If unsure whether a service exists, do NOT include it\n\nREQUIRED OUTPUT SCHEMA:\n{\n  \"overall_health\": \"healthy|warning|critical\",\n  \"total_alerts\": <number>,\n  \"critical_issues\": [\"service (namespace): alert - description\"],\n  \"warnings\": [\"service (namespace): alert - description\"],\n  \"patterns\": [\"namespace or issue pattern with affected service names\"],\n  \"recommendations\": [\"action for specific service in namespace\"],\n  \"summary\": \"Executive summary naming the most critical affected services\"\n}\n\nIMPORTANT: Always name services. Only output JSON. No prose, no markdown."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -1504,
        576
      ],
      "id": "fee51e59-2343-464f-ab49-cfc399c381d8",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "llama3.1:8b-instruct-q4_K_M",
        "options": {
          "temperature": 0.1,
          "topP": 1,
          "repeatPenalty": 1.1,
          "format": "json"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1616,
        800
      ],
      "id": "c54a9036-858f-4d72-820c-ed07ef1decbf",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "tM5sMEUD2xbMf8MN",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "log-aggregator"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [
        -1456,
        800
      ],
      "id": "750b456d-4368-4539-9307-8b0256aec547",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "pfw9vuxHhnNgPvL3",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "endpointUrl": "http://log-aggregator.tools.svc.cluster.local:8080/mcp/",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.2,
      "position": [
        -1280,
        800
      ],
      "id": "0dd53748-16da-433b-9c3f-64d88fdcd6e1",
      "name": "MCP Client"
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"overall_health\": \"healthy|warning|critical\",\n  \"total_alerts\": 15,\n  \"critical_issues\": [\"service (namespace): alert - description\"],\n  \"warnings\": [\"service (namespace): alert - description\"],\n  \"patterns\": [\"namespace or issue pattern with affected service names\"],\n  \"recommendations\": [\"action for specific service in namespace\"],\n  \"summary\": \"Executive summary naming the most critical affected services\"\n}",
        "autoFix": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -1168,
        800
      ],
      "id": "1f03bfdc-7413-444f-9db4-f56043e19228",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": "llama3.1:8b-instruct-q4_K_M",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1168,
        960
      ],
      "id": "1d986b6c-da47-4276-a651-c70f49f1e479",
      "name": "Ollama Chat Model1",
      "credentials": {
        "ollamaApi": {
          "id": "tM5sMEUD2xbMf8MN",
          "name": "Ollama account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Daily 22:00": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Output": {
      "main": [
        [
          {
            "node": "Has Alerts?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Alerts?": {
      "main": [
        [
          {
            "node": "Discord Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Critical?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Discord (No Alerts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Critical?": {
      "main": [
        [
          {
            "node": "Email (Critical Only)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Discord Notification": {
      "main": [
        [
          {
            "node": "Mark Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "MCP Client": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Format Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a10540ba-6958-4d05-b3c0-b861f8348698",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "75007051edd1ad2fbd58f37b402723f7b9822d012c2c15f3975a5ac3f9779d62"
  },
  "id": "14qK1oFB0hDRK41t",
  "tags": []
}
