{
  "name": "Kubernetes Log Summarizer",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 22
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -800,
        200
      ],
      "id": "999a675a-4c80-483a-8334-a6ce6d986e79",
      "name": "Daily 22:00"
    },
    {
      "parameters": {
        "jsCode": "const ollamaResponse = $input.first().json;\n\nlet analysis;\ntry {\n  let responseText = ollamaResponse.content || ollamaResponse.message?.content || '';\n  \n  // Strip markdown code blocks if present\n  responseText = responseText.replace(/^```(?:json)?\\s*\\n?/, '').replace(/\\n?```\\s*$/, '').trim();\n\n  // Try to parse directly first, then fall back to regex\n  try {\n    analysis = JSON.parse(responseText);\n  } catch {\n    const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      analysis = JSON.parse(jsonMatch[0]);\n    } else {\n      throw new Error('No JSON found in response');\n    }\n  }\n  \n  // Normalize arrays\n  const normalizeArray = (arr) => {\n    if (!Array.isArray(arr)) return [];\n    return arr.map(item => {\n      if (typeof item === 'string') return item;\n      if (typeof item === 'object') {\n        const values = Object.values(item);\n        if (values.length > 0) {\n          const first = values[0];\n          if (typeof first === 'string') return first;\n          if (typeof first === 'object' && first.description) return first.description;\n          return JSON.stringify(first);\n        }\n      }\n      return String(item);\n    });\n  };\n  \n  analysis.critical_issues = normalizeArray(analysis.critical_issues);\n  analysis.warnings = normalizeArray(analysis.warnings);\n  analysis.recommendations = normalizeArray(analysis.recommendations);\n  analysis.patterns = normalizeArray(analysis.patterns);\n  \n} catch (e) {\n  analysis = {\n    overall_health: 'unknown',\n    total_alerts: 0,\n    critical_issues: ['Failed to parse AI response: ' + e.message],\n    warnings: [],\n    patterns: [],\n    recommendations: ['Check Ollama connectivity'],\n    summary: 'Analysis failed'\n  };\n}\n\nconst healthEmoji = {\n  'healthy': '‚úÖ',\n  'warning': '‚ö†Ô∏è',\n  'critical': 'üî¥',\n  'unknown': '‚ùì'\n}[analysis.overall_health] || '‚ùì';\n\nconst today = new Date().toISOString().split('T')[0];\n\n// Build Discord embed\nconst discordEmbed = {\n  embeds: [{\n    title: `${healthEmoji} Kubernetes Daily Summary`,\n    color: analysis.overall_health === 'critical' ? 0xff0000 :\n           analysis.overall_health === 'warning' ? 0xffaa00 : 0x00ff00,\n    fields: [\n      {\n        name: 'üìä Overview',\n        value: `**Alerts:** ${analysis.total_alerts || 0}\\n**Period:** ${today}`,\n        inline: true\n      },\n      {\n        name: 'üè• Health',\n        value: analysis.overall_health.toUpperCase(),\n        inline: true\n      }\n    ],\n    description: analysis.summary,\n    timestamp: new Date().toISOString()\n  }]\n};\n\nif (analysis.critical_issues?.length > 0) {\n  discordEmbed.embeds[0].fields.push({\n    name: 'üî¥ Critical Issues',\n    value: analysis.critical_issues.slice(0, 5).map(i => `‚Ä¢ ${i}`).join('\\n'),\n    inline: false\n  });\n}\n\nif (analysis.warnings?.length > 0) {\n  discordEmbed.embeds[0].fields.push({\n    name: '‚ö†Ô∏è Warnings',\n    value: analysis.warnings.slice(0, 5).map(w => `‚Ä¢ ${w}`).join('\\n'),\n    inline: false\n  });\n}\n\nif (analysis.recommendations?.length > 0) {\n  discordEmbed.embeds[0].fields.push({\n    name: 'üí° Recommendations',\n    value: analysis.recommendations.slice(0, 5).map(r => `‚Ä¢ ${r}`).join('\\n'),\n    inline: false\n  });\n}\n\n// Build HTML email\nconst html = `\n<h2>${healthEmoji} Kubernetes Daily Summary - ${today}</h2>\n<p><strong>Overall Health:</strong> ${analysis.overall_health.toUpperCase()}</p>\n<p><strong>Total Alerts:</strong> ${analysis.total_alerts || 0}</p>\n\n<h3>üìù Summary</h3>\n<p>${analysis.summary}</p>\n\n<h3>üî¥ Critical Issues</h3>\n<ul>\n${analysis.critical_issues?.map(i => `<li>${i}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<h3>‚ö†Ô∏è Warnings</h3>\n<ul>\n${analysis.warnings?.map(w => `<li>${w}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<h3>üîç Patterns Detected</h3>\n<ul>\n${analysis.patterns?.map(p => `<li>${p}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<h3>üí° Recommendations</h3>\n<ul>\n${analysis.recommendations?.map(r => `<li>${r}</li>`).join('') || '<li>None</li>'}\n</ul>\n\n<hr>\n<p><em>Generated by Kubernetes Log Summarizer</em></p>\n`;\n\nreturn {\n  json: {\n    analysis,\n    discordEmbed,\n    emailSubject: `${healthEmoji} K8s Summary: ${analysis.overall_health.toUpperCase()} - ${today}`,\n    emailHtml: html,\n    isCritical: analysis.overall_health === 'critical',\n    hasAlerts: (analysis.total_alerts || 0) > 0\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        200
      ],
      "id": "8389e666-db8f-4509-9df2-eebae095a117",
      "name": "Format Output"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.DISCORD_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.discordEmbed) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        200,
        100
      ],
      "id": "9993878c-bdf9-4b97-9953-18b6adcd5b77",
      "name": "Discord Notification"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-critical",
              "leftValue": "={{ $json.isCritical }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        200,
        300
      ],
      "id": "7df34222-149f-4d85-8f15-dd96a06a84e9",
      "name": "Is Critical?"
    },
    {
      "parameters": {
        "fromEmail": "=overseerr@shadowmorph.info",
        "toEmail": "=olli@erinko.fi",
        "subject": "={{ $json.emailSubject }}",
        "html": "={{ $json.emailHtml }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        400,
        300
      ],
      "id": "b461bb4b-6766-47d4-bb9c-2698ee12baec",
      "name": "Email (Critical Only)",
      "webhookId": "d79f87df-bb07-4b9f-88ef-7ba543b107cb"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "llama3.1:8b-instruct-q4_K_M",
          "mode": "list",
          "cachedResultName": "llama3.1:8b-instruct-q4_K_M"
        },
        "messages": {
          "values": [
            {
              "content": "Analyze the Kubernetes cluster health for today. Use the available tools to gather data."
            }
          ]
        },
        "simplify": false,
        "options": {
          "system": "You are a Kubernetes cluster health analyst with access to MCP tools for querying cluster data.\n\nAVAILABLE TOOLS:\n- list_alerts: Get a lightweight list of today's alerts (call this first)\n- get_pod_logs: Fetch logs for a specific pod (namespace, pod required)\n- get_pod_events: Fetch Kubernetes events for a namespace/pod\n- get_pod_metrics: Get current CPU/memory for a pod\n- get_cluster_health: Get overall cluster health summary\n\nWORKFLOW:\n1. First call get_cluster_health to get an overview\n2. If there are alerts, call list_alerts to see them\n3. For any critical or interesting alerts, use get_pod_logs/get_pod_events to investigate\n4. Synthesize your findings into the required JSON output\n\nRULES:\n- Your FINAL response MUST be a valid JSON object\n- Do NOT include any text before or after the JSON\n- Do NOT use markdown code blocks\n- ALWAYS name the affected services - never just say \"PodCrashLooping (28 times)\"\n- Format: \"service (namespace): alert type - brief description\"\n- If multiple services have the same issue, list the top 5 most important ones\n- Group remaining by namespace if needed: \"media namespace: 3 more services with CPUThrottling\"\n- Look for PATTERNS: Multiple alerts from same namespace, recurring issue types\n\nGOOD EXAMPLES:\n- critical_issues: [\"sonarr (media): CrashLoopBackOff - restarting every 30s\", \"radarr (media): CrashLoopBackOff - OOM killed\", \"prowlarr (media): CrashLoopBackOff - config error\"]\n- warnings: [\"nginx-ingress-controller (ingress-nginx): CPUThrottlingHigh - 85% throttled\", \"external-dns (network): ExternalDNSStale - no updates in 1h\"]\n- patterns: [\"media namespace: 5 services experiencing memory pressure\", \"VolSync: 3 volumes out of sync (sonarr, radarr, bazarr)\"]\n\nBAD EXAMPLES (do NOT do this):\n- \"PodCrashLooping (28 times)\" - missing service names!\n- \"CPUThrottlingHigh (7 times)\" - which services?!\n\nREQUIRED OUTPUT SCHEMA:\n{\n  \"overall_health\": \"healthy|warning|critical\",\n  \"total_alerts\": <number>,\n  \"critical_issues\": [\"service (namespace): alert - description\"],\n  \"warnings\": [\"service (namespace): alert - description\"],\n  \"patterns\": [\"namespace or issue pattern with affected service names\"],\n  \"recommendations\": [\"action for specific service in namespace\"],\n  \"summary\": \"Executive summary naming the most critical affected services\"\n}\n\nIMPORTANT: Always name services. Only output JSON. No prose, no markdown.",
          "temperature": 0,
          "top_p": 1,
          "repeat_penalty": 1.1,
          "num_ctx": 8192,
          "num_batch": 1024,
          "format": "json"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.ollama",
      "typeVersion": 1,
      "position": [
        -500,
        200
      ],
      "id": "2bf390a5-8910-42c4-8191-8c3203622612",
      "name": "Ollama Analysis",
      "credentials": {
        "ollamaApi": {
          "id": "tM5sMEUD2xbMf8MN",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://log-aggregator.tools.svc.cluster.local:8080/api/complete",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        100
      ],
      "id": "433359eb-7e33-4750-bdeb-8bb918f6f9b5",
      "name": "Mark Complete"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-alerts",
              "leftValue": "={{ $json.hasAlerts }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        200
      ],
      "id": "d0ceaa98-4bca-45f6-8035-5ff9da5a1986",
      "name": "Has Alerts?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.DISCORD_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"embeds\": [{\n    \"title\": \"‚úÖ Kubernetes Daily Summary\",\n    \"color\": 65280,\n    \"description\": \"No alerts recorded in the last 24 hours. All systems healthy.\",\n    \"timestamp\": \"{{ new Date().toISOString() }}\"\n  }]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        200,
        400
      ],
      "id": "6665e22b-5915-4241-9504-faf0da6a7c1e",
      "name": "Discord (No Alerts)"
    },
    {
      "parameters": {
        "endpointUrl": "http://log-aggregator.tools.svc.cluster.local:8080/mcp/",
        "options": {
          "timeout": 120000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.mcpClientTool",
      "typeVersion": 1.2,
      "position": [
        -500,
        400
      ],
      "id": "e798eacf-e807-44f5-b5b3-b73230da7fc2",
      "name": "Log Aggregator MCP"
    }
  ],
  "pinData": {},
  "connections": {
    "Daily 22:00": {
      "main": [
        [
          {
            "node": "Ollama Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Output": {
      "main": [
        [
          {
            "node": "Has Alerts?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Alerts?": {
      "main": [
        [
          {
            "node": "Discord Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Critical?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Discord (No Alerts)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Critical?": {
      "main": [
        [
          {
            "node": "Email (Critical Only)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Analysis": {
      "main": [
        [
          {
            "node": "Format Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Discord Notification": {
      "main": [
        [
          {
            "node": "Mark Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Aggregator MCP": {
      "ai_tool": [
        [
          {
            "node": "Ollama Analysis",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "906aa4af-6b80-4bfa-81c7-eaae6d2bf1e3",
  "meta": {
    "instanceId": "75007051edd1ad2fbd58f37b402723f7b9822d012c2c15f3975a5ac3f9779d62"
  },
  "id": "VPovxu1g3KStu4lp",
  "tags": []
}
