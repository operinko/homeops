apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    banzaicloud.com/last-applied: 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
    deployment.kubernetes.io/revision: "2"
  creationTimestamp: "2025-05-05T22:03:26Z"
  generation: 20
  name: csi-rbdplugin-provisioner
  namespace: rook-ceph
  ownerReferences:
  - apiVersion: apps/v1
    blockOwnerDeletion: false
    controller: true
    kind: Deployment
    name: rook-ceph-operator
    uid: 6bece901-4fb1-4b0f-aa7f-517738a735d5
  resourceVersion: "20934110"
  uid: 4e9cac17-0178-412e-b0e6-25f2fec6907b
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: csi-rbdplugin-provisioner
  strategy:
    type: Recreate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: csi-rbdplugin-provisioner
        contains: csi-rbdplugin-metrics
    spec:
      affinity:
        nodeAffinity: {}
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - csi-rbdplugin-provisioner
            topologyKey: kubernetes.io/hostname
      containers:
      - args:
        - --csi-address=$(ADDRESS)
        - --v=0
        - --timeout=2m30s
        - --retry-interval-start=500ms
        - --leader-election=true
        - --leader-election-namespace=rook-ceph
        - --leader-election-lease-duration=2m17s
        - --leader-election-renew-deadline=1m47s
        - --leader-election-retry-period=26s
        - --default-fstype=ext4
        - --extra-create-metadata=true
        - --prevent-volume-mode-conversion=true
        - --feature-gates=HonorPVReclaimPolicy=true
        - --feature-gates=Topology=false
        env:
        - name: ADDRESS
          value: unix:///csi/csi-provisioner.sock
        image: registry.k8s.io/sig-storage/csi-provisioner:v5.1.0
        imagePullPolicy: IfNotPresent
        name: csi-provisioner
        resources:
          limits:
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /csi
          name: socket-dir
      - args:
        - --csi-address=$(ADDRESS)
        - --v=0
        - --timeout=2m30s
        - --leader-election=true
        - --leader-election-namespace=rook-ceph
        - --leader-election-lease-duration=2m17s
        - --leader-election-renew-deadline=1m47s
        - --leader-election-retry-period=26s
        - --handle-volume-inuse-error=false
        - --feature-gates=RecoverVolumeExpansionFailure=true
        env:
        - name: ADDRESS
          value: unix:///csi/csi-provisioner.sock
        image: registry.k8s.io/sig-storage/csi-resizer:v1.13.1
        imagePullPolicy: IfNotPresent
        name: csi-resizer
        resources:
          limits:
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /csi
          name: socket-dir
      - args:
        - --v=0
        - --timeout=2m30s
        - --csi-address=$(ADDRESS)
        - --leader-election=true
        - --leader-election-namespace=rook-ceph
        - --leader-election-lease-duration=2m17s
        - --leader-election-renew-deadline=1m47s
        - --leader-election-retry-period=26s
        - --default-fstype=ext4
        env:
        - name: ADDRESS
          value: /csi/csi-provisioner.sock
        image: registry.k8s.io/sig-storage/csi-attacher:v4.8.0
        imagePullPolicy: IfNotPresent
        name: csi-attacher
        resources:
          limits:
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /csi
          name: socket-dir
      - args:
        - --csi-address=$(ADDRESS)
        - --v=0
        - --timeout=2m30s
        - --leader-election=true
        - --leader-election-namespace=rook-ceph
        - --leader-election-lease-duration=2m17s
        - --leader-election-renew-deadline=1m47s
        - --leader-election-retry-period=26s
        - --extra-create-metadata=true
        - --enable-volume-group-snapshots=true
        env:
        - name: ADDRESS
          value: unix:///csi/csi-provisioner.sock
        image: registry.k8s.io/sig-storage/csi-snapshotter:v8.2.0
        imagePullPolicy: IfNotPresent
        name: csi-snapshotter
        resources:
          limits:
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /csi
          name: socket-dir
      - args:
        - --nodeid=$(NODE_ID)
        - --endpoint=$(CSI_ENDPOINT)
        - --v=0
        - --type=rbd
        - --controllerserver=true
        - --drivername=rook-ceph.rbd.csi.ceph.com
        - --pidlimit=-1
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        - name: NODE_ID
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: CSI_ENDPOINT
          value: unix:///csi/csi-provisioner.sock
        image: quay.io/cephcsi/cephcsi:v3.14.0
        imagePullPolicy: IfNotPresent
        name: csi-rbdplugin
        resources:
          limits:
            memory: 1Gi
          requests:
            memory: 512Mi
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /csi
          name: socket-dir
        - mountPath: /dev
          name: host-dev
        - mountPath: /sys
          name: host-sys
        - mountPath: /lib/modules
          name: lib-modules
          readOnly: true
        - mountPath: /etc/ceph-csi-config/
          name: ceph-csi-configs
        - mountPath: /tmp/csi/keys
          name: keys-tmp-dir
        - mountPath: /run/secrets/tokens
          name: oidc-token
          readOnly: true
      dnsPolicy: ClusterFirst
      priorityClassName: system-cluster-critical
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      serviceAccount: rook-csi-rbd-provisioner-sa
      serviceAccountName: rook-csi-rbd-provisioner-sa
      terminationGracePeriodSeconds: 30
      volumes:
      - hostPath:
          path: /dev
          type: ""
        name: host-dev
      - hostPath:
          path: /sys
          type: ""
        name: host-sys
      - hostPath:
          path: /lib/modules
          type: ""
        name: lib-modules
      - emptyDir:
          medium: Memory
        name: socket-dir
      - name: ceph-csi-configs
        projected:
          defaultMode: 420
          sources:
          - configMap:
              items:
              - key: csi-cluster-config-json
                path: config.json
              name: rook-ceph-csi-config
          - configMap:
              items:
              - key: csi-mapping-config-json
                path: cluster-mapping.json
              name: rook-ceph-csi-mapping-config
      - emptyDir:
          medium: Memory
        name: keys-tmp-dir
      - name: oidc-token
        projected:
          defaultMode: 420
          sources:
          - serviceAccountToken:
              audience: ceph-csi-kms
              expirationSeconds: 3600
              path: oidc-token
status:
  conditions:
  - lastTransitionTime: "2025-05-05T22:39:45Z"
    lastUpdateTime: "2025-05-05T22:39:45Z"
    message: Deployment does not have minimum availability.
    reason: MinimumReplicasUnavailable
    status: "False"
    type: Available
  - lastTransitionTime: "2025-05-05T22:03:27Z"
    lastUpdateTime: "2025-05-05T22:49:51Z"
    message: ReplicaSet "csi-rbdplugin-provisioner-95676878c" is progressing.
    reason: ReplicaSetUpdated
    status: "True"
    type: Progressing
  observedGeneration: 20
  replicas: 2
  unavailableReplicas: 2
  updatedReplicas: 2
